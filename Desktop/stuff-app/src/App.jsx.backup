import React, {
  useState,
  useEffect,
  useRef,
  useMemo,
  useCallback,
} from "react";
import {
  Plus,
  Inbox,
  Calendar,
  CheckCircle2,
  List,
  Tag,
  Circle,
  ChevronRight,
  Star,
  Trash2,
  MoreHorizontal,
  Clock,
  Repeat,
  Bell,
  GripVertical,
  X,
  StickyNote,
  Search,
  ChevronLeft,
  Settings,
  BarChart3,
} from "lucide-react";

const DateTimePicker = ({
  value,
  onChange,
  placeholder = "Select date & time",
  timeFormat = "12",
  isDarkMode = false,
}) => {
  const [showPicker, setShowPicker] = useState(false);
  const [selectedDate, setSelectedDate] = useState(
    value ? new Date(value) : new Date(),
  );
  const [currentMonth, setCurrentMonth] = useState(
    value ? new Date(value) : new Date(),
  );
  const [selectedTime, setSelectedTime] = useState(
    value ? new Date(value).toTimeString().slice(0, 5) : "09:00",
  );
  const pickerRef = useRef(null);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (pickerRef.current && !pickerRef.current.contains(event.target)) {
        setShowPicker(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const getDaysInMonth = (date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    const days = [];
    for (let i = 0; i < startingDayOfWeek; i++) {
      days.push(null);
    }
    for (let i = 1; i <= daysInMonth; i++) {
      days.push(new Date(year, month, i));
    }
    return days;
  };

  const handleDateSelect = (date) => {
    if (!date) return;
    setSelectedDate(date);
  };

  const handleConfirm = () => {
    const [hours, minutes] = selectedTime.split(":").map(Number);
    const finalDate = new Date(selectedDate);
    finalDate.setHours(hours, minutes, 0, 0);
    onChange(finalDate.toISOString());
    setShowPicker(false);
  };

  const handleClear = () => {
    onChange("");
    setShowPicker(false);
  };

  const formatDisplayDate = () => {
    if (!value) return placeholder;
    const date = new Date(value);
    return date.toLocaleString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
      hour: "numeric",
      minute: "2-digit",
      hour12: timeFormat === "12",
    });
  };

  const isToday = (date) => {
    const today = new Date();
    return (
      date &&
      date.getDate() === today.getDate() &&
      date.getMonth() === today.getMonth() &&
      date.getFullYear() === today.getFullYear()
    );
  };

  const isSameDay = (date1, date2) => {
    return (
      date1 &&
      date2 &&
      date1.getDate() === date2.getDate() &&
      date1.getMonth() === date2.getMonth() &&
      date1.getFullYear() === date2.getFullYear()
    );
  };

  const days = getDaysInMonth(currentMonth);
  const monthName = currentMonth.toLocaleString("en-US", {
    month: "long",
    year: "numeric",
  });

  return (
    <div style={{ position: "relative" }} ref={pickerRef}>
      <button
        type="button"
        onClick={() => setShowPicker(!showPicker)}
        style={{
          color: value ? (isDarkMode ? "#ffffff" : "#1C1C1E") : "#8E8E93",
          backgroundColor: isDarkMode ? "#1a1a1a" : "white",
          borderRadius: "12px",
          border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
        }}
        className="w-full px-4 py-3 text-sm text-left focus:outline-none focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF] transition-smooth"
      >
        {formatDisplayDate()}
      </button>
      {showPicker && (
        <div
          style={{
            position: "absolute",
            top: "calc(100% + 8px)",
            left: 0,
            backgroundColor: isDarkMode ? "#252525" : "white",
            borderRadius: "16px",
            border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
            boxShadow: "0 8px 32px rgba(0, 0, 0, 0.12)",
            zIndex: 1000,
            width: "320px",
          }}
          className="animate-scale-in"
        >
          <div style={{ padding: "16px" }}>
            {/* Month Navigation */}
            <div
              style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                marginBottom: "16px",
              }}
            >
              <button
                type="button"
                onClick={() =>
                  setCurrentMonth(
                    new Date(
                      currentMonth.getFullYear(),
                      currentMonth.getMonth() - 1,
                    ),
                  )
                }
                style={{ color: "#007AFF", padding: "4px" }}
                className="hover:bg-[#007AFF10] rounded-lg transition-smooth"
              >
                <ChevronLeft className="w-5 h-5" />
              </button>
              <span
                style={{
                  color: isDarkMode ? "#ffffff" : "#1C1C1E",
                  fontSize: "15px",
                  fontWeight: "600",
                }}
              >
                {monthName}
              </span>
              <button
                type="button"
                onClick={() =>
                  setCurrentMonth(
                    new Date(
                      currentMonth.getFullYear(),
                      currentMonth.getMonth() + 1,
                    ),
                  )
                }
                style={{ color: "#007AFF", padding: "4px" }}
                className="hover:bg-[#007AFF10] rounded-lg transition-smooth"
              >
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>

            {/* Day Headers */}
            <div
              style={{
                display: "grid",
                gridTemplateColumns: "repeat(7, 1fr)",
                gap: "4px",
                marginBottom: "8px",
              }}
            >
              {["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"].map((day) => (
                <div
                  key={day}
                  style={{
                    color: "#8E8E93",
                    fontSize: "11px",
                    fontWeight: "600",
                    textAlign: "center",
                    padding: "4px",
                  }}
                >
                  {day}
                </div>
              ))}
            </div>

            {/* Calendar Days */}
            <div
              style={{
                display: "grid",
                gridTemplateColumns: "repeat(7, 1fr)",
                gap: "4px",
                marginBottom: "16px",
              }}
            >
              {days.map((day, index) => {
                const isSelected = isSameDay(day, selectedDate);
                const isTodayDate = isToday(day);
                return (
                  <button
                    key={index}
                    type="button"
                    onClick={() => handleDateSelect(day)}
                    disabled={!day}
                    style={{
                      padding: "8px",
                      borderRadius: "8px",
                      fontSize: "13px",
                      backgroundColor: isSelected
                        ? "#007AFF"
                        : isTodayDate
                          ? isDarkMode
                            ? "rgba(0, 122, 255, 0.2)"
                            : "#007AFF10"
                          : "transparent",
                      color: isSelected
                        ? "white"
                        : isTodayDate
                          ? "#007AFF"
                          : day
                            ? isDarkMode
                              ? "#ffffff"
                              : "#1C1C1E"
                            : "transparent",
                      fontWeight: isSelected || isTodayDate ? "600" : "400",
                      border: "none",
                      cursor: day ? "pointer" : "default",
                    }}
                    className={
                      day ? "hover:bg-[#F2F2F7] transition-smooth" : ""
                    }
                  >
                    {day ? day.getDate() : ""}
                  </button>
                );
              })}
            </div>

            {/* Time Picker */}
            <div style={{ marginBottom: "16px" }}>
              <label
                style={{
                  color: "#8E8E93",
                  fontSize: "12px",
                  fontWeight: "600",
                  display: "block",
                  marginBottom: "8px",
                }}
              >
                TIME
              </label>
              <input
                type="time"
                value={selectedTime}
                onChange={(e) => setSelectedTime(e.target.value)}
                style={{
                  width: "100%",
                  padding: "10px 12px",
                  borderRadius: "10px",
                  border: isDarkMode
                    ? "1px solid #3a3a3a"
                    : "1px solid #E5E5E5",
                  fontSize: "14px",
                  color: isDarkMode ? "#ffffff" : "#1C1C1E",
                  backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                }}
                className="focus:outline-none focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF]"
              />
            </div>

            {/* Action Buttons */}
            <div style={{ display: "flex", gap: "8px" }}>
              <button
                type="button"
                onClick={handleClear}
                style={{
                  flex: 1,
                  padding: "10px",
                  borderRadius: "10px",
                  border: isDarkMode
                    ? "1px solid #3a3a3a"
                    : "1px solid #E5E5E5",
                  backgroundColor: isDarkMode ? "#2a2a2a" : "white",
                  color: "#FF3B30",
                  fontSize: "14px",
                  fontWeight: "600",
                }}
                className="hover:bg-[#FF3B3010] transition-smooth"
              >
                Clear
              </button>
              <button
                type="button"
                onClick={handleConfirm}
                style={{
                  flex: 1,
                  padding: "10px",
                  borderRadius: "10px",
                  backgroundColor: "#007AFF",
                  color: "white",
                  fontSize: "14px",
                  fontWeight: "600",
                  border: "none",
                }}
                className="hover:bg-[#0051D5] transition-smooth"
              >
                Confirm
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const StuffApp = () => {
  // Load from localStorage or use defaults
  const [tasks, setTasks] = useState(() => {
    const saved = localStorage.getItem("stuff-app-tasks");
    return saved ? JSON.parse(saved) : [];
  });
  const [projects, setProjects] = useState(() => {
    const saved = localStorage.getItem("stuff-app-projects");
    return saved ? JSON.parse(saved) : [];
  });
  const [areas, setAreas] = useState(() => {
    const saved = localStorage.getItem("stuff-app-areas");
    return saved ? JSON.parse(saved) : [];
  });
  const [tags, setTags] = useState(() => {
    const saved = localStorage.getItem("stuff-app-tags");
    return saved ? JSON.parse(saved) : [];
  });
  const [selectedView, setSelectedView] = useState(() => {
    const saved = localStorage.getItem("stuff-app-selectedView");
    return saved || "inbox";
  });
  const [selectedProject, setSelectedProject] = useState(() => {
    const saved = localStorage.getItem("stuff-app-selectedProject");
    return saved ? JSON.parse(saved) : null;
  });
  const [selectedArea, setSelectedArea] = useState(() => {
    const saved = localStorage.getItem("stuff-app-selectedArea");
    return saved ? JSON.parse(saved) : null;
  });
  const [newTaskInput, setNewTaskInput] = useState("");
  const [showNewProjectInput, setShowNewProjectInput] = useState(false);
  const [showNewAreaInput, setShowNewAreaInput] = useState(false);
  const [newProjectName, setNewProjectName] = useState("");
  const [newAreaName, setNewAreaName] = useState("");
  const [selectedTask, setSelectedTask] = useState(null);
  const [showTaskDetail, setShowTaskDetail] = useState(false);
  const [draggedTask, setDraggedTask] = useState(null);
  const [dragOverTask, setDragOverTask] = useState(null);
  const [showTagPanel, setShowTagPanel] = useState(false);
  const [tagPanelClosing, setTagPanelClosing] = useState(false);
  const [newTagName, setNewTagName] = useState("");
  const [editingProject, setEditingProject] = useState(null);
  const [editingArea, setEditingArea] = useState(null);
  const [showProjectPanel, setShowProjectPanel] = useState(false);
  const [projectPanelClosing, setProjectPanelClosing] = useState(false);
  const [showQuickFind, setShowQuickFind] = useState(false);
  const [quickFindSearch, setQuickFindSearch] = useState("");
  const [quickFindClosing, setQuickFindClosing] = useState(false);
  const [editingHeaderName, setEditingHeaderName] = useState(false);
  const [showEmojiPicker, setShowEmojiPicker] = useState(false);
  const [emojiSearch, setEmojiSearch] = useState("");
  const [draggedProject, setDraggedProject] = useState(null);
  const [dragOverProject, setDragOverProject] = useState(null);
  const [dragOverArea, setDragOverArea] = useState(null);
  const [expandedAreas, setExpandedAreas] = useState(() => {
    const saved = localStorage.getItem("stuff-app-expandedAreas");
    return saved ? JSON.parse(saved) : {};
  });
  const [showSettingsPanel, setShowSettingsPanel] = useState(false);
  const [settingsPanelItem, setSettingsPanelItem] = useState(null);
  const [settingsPanelType, setSettingsPanelType] = useState(null);
  const [showAppSettings, setShowAppSettings] = useState(false);
  const [appSettingsClosing, setAppSettingsClosing] = useState(false);
  const [contextMenu, setContextMenu] = useState(null);
  const [selectedTheme, setSelectedTheme] = useState(() => {
    const saved = localStorage.getItem("stuff-app-theme");
    return saved || "none";
  });
  const [defaultView, setDefaultView] = useState(() => {
    const saved = localStorage.getItem("stuff-app-defaultView");
    return saved || "inbox";
  });
  const [completionSound, setCompletionSound] = useState(() => {
    const saved = localStorage.getItem("stuff-app-completionSound");
    return saved === "true";
  });
  const [showConfirmDialogs, setShowConfirmDialogs] = useState(() => {
    const saved = localStorage.getItem("stuff-app-showConfirmDialogs");
    return saved !== "false"; // default true
  });
  const [showTaskCounts, setShowTaskCounts] = useState(() => {
    const saved = localStorage.getItem("stuff-app-showTaskCounts");
    return saved !== "false"; // default true
  });
  const [timeFormat, setTimeFormat] = useState(() => {
    const saved = localStorage.getItem("stuff-app-timeFormat");
    return saved || "12"; // "12" or "24"
  });
  const [detectedDateTime, setDetectedDateTime] = useState(null);
  const [highlightedRange, setHighlightedRange] = useState(null);
  const [newlyAddedTaskId, setNewlyAddedTaskId] = useState(null);
  const [completingTaskIds, setCompletingTaskIds] = useState([]);
  const inputRef = useRef(null);
  const cursorPositionRef = useRef(null);

  // Save to localStorage whenever data changes
  useEffect(() => {
    localStorage.setItem("stuff-app-tasks", JSON.stringify(tasks));
  }, [tasks]);

  useEffect(() => {
    localStorage.setItem("stuff-app-projects", JSON.stringify(projects));
  }, [projects]);

  useEffect(() => {
    localStorage.setItem("stuff-app-areas", JSON.stringify(areas));
  }, [areas]);

  useEffect(() => {
    localStorage.setItem("stuff-app-tags", JSON.stringify(tags));
  }, [tags]);

  useEffect(() => {
    localStorage.setItem("stuff-app-selectedView", selectedView);
  }, [selectedView]);

  useEffect(() => {
    localStorage.setItem(
      "stuff-app-selectedProject",
      JSON.stringify(selectedProject),
    );
  }, [selectedProject]);

  useEffect(() => {
    localStorage.setItem(
      "stuff-app-selectedArea",
      JSON.stringify(selectedArea),
    );
  }, [selectedArea]);

  useEffect(() => {
    localStorage.setItem(
      "stuff-app-expandedAreas",
      JSON.stringify(expandedAreas),
    );
  }, [expandedAreas]);

  useEffect(() => {
    localStorage.setItem("stuff-app-theme", selectedTheme);
  }, [selectedTheme]);

  useEffect(() => {
    localStorage.setItem("stuff-app-defaultView", defaultView);
  }, [defaultView]);

  useEffect(() => {
    localStorage.setItem(
      "stuff-app-completionSound",
      completionSound.toString(),
    );
  }, [completionSound]);

  useEffect(() => {
    localStorage.setItem(
      "stuff-app-showConfirmDialogs",
      showConfirmDialogs.toString(),
    );
  }, [showConfirmDialogs]);

  useEffect(() => {
    localStorage.setItem("stuff-app-showTaskCounts", showTaskCounts.toString());
  }, [showTaskCounts]);

  useEffect(() => {
    localStorage.setItem("stuff-app-timeFormat", timeFormat);
  }, [timeFormat]);

  // Set default view on startup
  useEffect(() => {
    if (selectedView === "inbox" && defaultView !== "inbox") {
      setSelectedView(defaultView);
    }
  }, []);

  // Effect to restore cursor position after render
  React.useEffect(() => {
    if (inputRef.current && cursorPositionRef.current !== null) {
      inputRef.current.setSelectionRange(
        cursorPositionRef.current,
        cursorPositionRef.current,
      );
    }
  }, [highlightedRange]);

  const emojiList = [
    { emoji: "ðŸ“", name: "folder", keywords: ["folder", "file", "organize"] },
    {
      emoji: "ðŸ’¼",
      name: "briefcase",
      keywords: ["briefcase", "work", "business", "job"],
    },
    {
      emoji: "ðŸŽ¯",
      name: "target",
      keywords: ["target", "goal", "aim", "dart"],
    },
    {
      emoji: "ðŸš€",
      name: "rocket",
      keywords: ["rocket", "launch", "space", "startup"],
    },
    {
      emoji: "ðŸ’¡",
      name: "bulb",
      keywords: ["bulb", "idea", "light", "innovation"],
    },
    {
      emoji: "ðŸ“Š",
      name: "chart",
      keywords: ["chart", "data", "analytics", "graph"],
    },
    {
      emoji: "ðŸŽ¨",
      name: "art",
      keywords: ["art", "paint", "design", "creative"],
    },
    {
      emoji: "ðŸ“",
      name: "note",
      keywords: ["note", "write", "document", "memo"],
    },
    {
      emoji: "âš¡",
      name: "lightning",
      keywords: ["lightning", "fast", "energy", "power"],
    },
    {
      emoji: "ðŸ”§",
      name: "wrench",
      keywords: ["wrench", "tool", "fix", "repair"],
    },
    { emoji: "ðŸ ", name: "home", keywords: ["home", "house", "family"] },
    {
      emoji: "ðŸ’°",
      name: "money",
      keywords: ["money", "cash", "finance", "dollar"],
    },
    {
      emoji: "ðŸŽ“",
      name: "graduation",
      keywords: ["graduation", "education", "school", "learn"],
    },
    {
      emoji: "ðŸƒ",
      name: "running",
      keywords: ["running", "exercise", "fitness", "sport"],
    },
    {
      emoji: "ðŸŒŸ",
      name: "star",
      keywords: ["star", "favorite", "special", "featured"],
    },
    {
      emoji: "â¤ï¸",
      name: "heart",
      keywords: ["heart", "love", "like", "favorite"],
    },
    {
      emoji: "ðŸ”¥",
      name: "fire",
      keywords: ["fire", "hot", "trending", "flame"],
    },
    {
      emoji: "ðŸŽµ",
      name: "music",
      keywords: ["music", "song", "audio", "sound"],
    },
    {
      emoji: "ðŸ“±",
      name: "phone",
      keywords: ["phone", "mobile", "device", "smartphone"],
    },
    {
      emoji: "ðŸ’»",
      name: "laptop",
      keywords: ["laptop", "computer", "code", "tech"],
    },
    {
      emoji: "ðŸ“š",
      name: "books",
      keywords: ["books", "library", "reading", "study"],
    },
    {
      emoji: "ðŸŒˆ",
      name: "rainbow",
      keywords: ["rainbow", "color", "colorful", "pride"],
    },
    { emoji: "ðŸ•", name: "pizza", keywords: ["pizza", "food", "eat"] },
    {
      emoji: "â˜•",
      name: "coffee",
      keywords: ["coffee", "drink", "cafe", "tea"],
    },
    {
      emoji: "ðŸŽ¬",
      name: "movie",
      keywords: ["movie", "film", "cinema", "video"],
    },
    {
      emoji: "ðŸ†",
      name: "trophy",
      keywords: ["trophy", "win", "award", "achievement"],
    },
    {
      emoji: "ðŸŽ®",
      name: "game",
      keywords: ["game", "gaming", "play", "controller"],
    },
    {
      emoji: "âœˆï¸",
      name: "airplane",
      keywords: ["airplane", "travel", "flight", "trip"],
    },
    {
      emoji: "ðŸŒ",
      name: "globe",
      keywords: ["globe", "world", "earth", "international"],
    },
    {
      emoji: "ðŸ“·",
      name: "camera",
      keywords: ["camera", "photo", "picture", "photography"],
    },
    {
      emoji: "ðŸŽ‰",
      name: "party",
      keywords: ["party", "celebrate", "celebration", "confetti"],
    },
    {
      emoji: "ðŸŒº",
      name: "flower",
      keywords: ["flower", "nature", "plant", "garden"],
    },
  ];

  const getFilteredEmojis = () => {
    if (!emojiSearch.trim()) return emojiList;
    const search = emojiSearch.toLowerCase();
    return emojiList.filter(
      (item) =>
        item.name.toLowerCase().includes(search) ||
        item.keywords.some((keyword) => keyword.includes(search)),
    );
  };

  const parseNaturalLanguageDate = (text) => {
    const lowerText = text.toLowerCase();
    const now = new Date();

    // Patterns for detection
    const patterns = [
      // Relative days
      {
        regex: /\btomorrow\b/,
        getDate: () => {
          const d = new Date(now);
          d.setDate(d.getDate() + 1);
          return d;
        },
      },
      { regex: /\btoday\b/, getDate: () => new Date(now) },
      {
        regex: /\bin (\d+) days?\b/,
        getDate: (match) => {
          const d = new Date(now);
          d.setDate(d.getDate() + parseInt(match[1]));
          return d;
        },
      },

      // Days of week
      { regex: /\bmonday\b/, getDate: () => getNextWeekday(1) },
      { regex: /\btuesday\b/, getDate: () => getNextWeekday(2) },
      { regex: /\bwednesday\b/, getDate: () => getNextWeekday(3) },
      { regex: /\bthursday\b/, getDate: () => getNextWeekday(4) },
      { regex: /\bfriday\b/, getDate: () => getNextWeekday(5) },
      { regex: /\bsaturday\b/, getDate: () => getNextWeekday(6) },
      { regex: /\bsunday\b/, getDate: () => getNextWeekday(0) },

      // This/Next week
      {
        regex:
          /\bthis (monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/,
        getDate: (match) => getNextWeekday(getDayNumber(match[1])),
      },
      {
        regex:
          /\bnext (monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/,
        getDate: (match) => {
          const d = getNextWeekday(getDayNumber(match[1]));
          d.setDate(d.getDate() + 7);
          return d;
        },
      },
      {
        regex: /\bnext week\b/,
        getDate: () => {
          const d = new Date(now);
          d.setDate(d.getDate() + 7);
          return d;
        },
      },
    ];

    function getNextWeekday(targetDay) {
      const d = new Date(now);
      const currentDay = d.getDay();
      let daysToAdd = targetDay - currentDay;
      if (daysToAdd <= 0) daysToAdd += 7;
      d.setDate(d.getDate() + daysToAdd);
      return d;
    }

    function getDayNumber(day) {
      const days = {
        sunday: 0,
        monday: 1,
        tuesday: 2,
        wednesday: 3,
        thursday: 4,
        friday: 5,
        saturday: 6,
      };
      return days[day.toLowerCase()];
    }

    // Check for date patterns
    let date = null;
    let matchedText = null;

    for (const pattern of patterns) {
      const match = lowerText.match(pattern.regex);
      if (match) {
        date = pattern.getDate(match);
        matchedText = match[0];
        break;
      }
    }

    if (!date) return null;

    // Check for time patterns
    const timePatterns = [
      // "at 4:30pm" or "at 4:30"
      {
        regex: /\bat (\d{1,2}):(\d{2})\s*(am|pm)?\b/i,
        getTime: (match) => {
          let hours = parseInt(match[1]);
          const minutes = parseInt(match[2]);
          const meridiem = match[3]?.toLowerCase();
          if (meridiem === "pm" && hours !== 12) hours += 12;
          if (meridiem === "am" && hours === 12) hours = 0;
          return { hours, minutes, text: match[0] };
        },
      },
      // "at 5pm" or "at 5am"
      {
        regex: /\bat (\d{1,2})\s*(am|pm)\b/i,
        getTime: (match) => {
          let hours = parseInt(match[1]);
          const meridiem = match[2].toLowerCase();
          if (meridiem === "pm" && hours !== 12) hours += 12;
          if (meridiem === "am" && hours === 12) hours = 0;
          return { hours, minutes: 0, text: match[0] };
        },
      },
      // "4:30pm" or "4:30am" (without "at")
      {
        regex: /\b(\d{1,2}):(\d{2})\s*(am|pm)\b/i,
        getTime: (match) => {
          let hours = parseInt(match[1]);
          const minutes = parseInt(match[2]);
          const meridiem = match[3].toLowerCase();
          if (meridiem === "pm" && hours !== 12) hours += 12;
          if (meridiem === "am" && hours === 12) hours = 0;
          return { hours, minutes, text: match[0] };
        },
      },
      // "5pm" or "9am" (without "at")
      {
        regex: /\b(\d{1,2})\s*(am|pm)\b/i,
        getTime: (match) => {
          let hours = parseInt(match[1]);
          const meridiem = match[2].toLowerCase();
          if (meridiem === "pm" && hours !== 12) hours += 12;
          if (meridiem === "am" && hours === 12) hours = 0;
          return { hours, minutes: 0, text: match[0] };
        },
      },
      // "in the morning/afternoon/evening/night"
      {
        regex: /\bin the (morning|afternoon|evening|night)\b/,
        getTime: (match) => {
          const times = { morning: 9, afternoon: 14, evening: 18, night: 20 };
          return { hours: times[match[1]], minutes: 0, text: match[0] };
        },
      },
    ];

    let time = null;
    for (const pattern of timePatterns) {
      const match = lowerText.match(pattern.regex);
      if (match) {
        time = pattern.getTime(match);
        matchedText += " " + time.text;
        break;
      }
    }

    if (time) {
      date.setHours(time.hours, time.minutes, 0, 0);
    } else {
      date.setHours(9, 0, 0, 0); // Default to 9 AM
    }

    return { date, matchedText: matchedText.trim() };
  };

  useEffect(() => {
    const handleClick = () => setContextMenu(null);
    if (contextMenu) {
      document.addEventListener("click", handleClick);
      return () => document.removeEventListener("click", handleClick);
    }
  }, [contextMenu]);

  useEffect(() => {
    const handleKeyDown = (e) => {
      if (
        e.shiftKey &&
        e.key === "N" &&
        !e.metaKey &&
        !e.ctrlKey &&
        document.activeElement.tagName !== "INPUT" &&
        document.activeElement.tagName !== "TEXTAREA"
      ) {
        e.preventDefault();
        inputRef.current?.focus();
      }
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        setShowQuickFind(true);
      }
      if (e.key === "Escape") {
        if (showQuickFind) {
          setQuickFindClosing(true);
          setTimeout(() => {
            setShowQuickFind(false);
            setQuickFindSearch("");
            setQuickFindClosing(false);
          }, 200);
        } else if (showTaskDetail) {
          setShowTaskDetail(false);
          setSelectedTask(null);
        }
      }
      if (
        e.key >= "1" &&
        e.key <= "6" &&
        !e.metaKey &&
        !e.ctrlKey &&
        !showQuickFind &&
        document.activeElement.tagName !== "INPUT" &&
        document.activeElement.tagName !== "TEXTAREA"
      ) {
        const views = [
          "inbox",
          "today",
          "upcoming",
          "anytime",
          "someday",
          "logbook",
        ];
        const index = parseInt(e.key) - 1;
        if (views[index]) {
          setSelectedView(views[index]);
          setSelectedProject(null);
          setSelectedArea(null);
        }
      }
    };
    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [showTaskDetail, showQuickFind]);

  useEffect(() => {
    // Close task detail panel when view changes
    setShowTaskDetail(false);
    setSelectedTask(null);
  }, [selectedView, selectedProject, selectedArea]);

  useEffect(() => {
    if (Notification.permission === "default") {
      Notification.requestPermission();
    }
    const checkReminders = setInterval(() => {
      const now = new Date();
      tasks.forEach((task) => {
        if (task.reminder && !task.completed && !task.reminderShown) {
          const reminderTime = new Date(task.reminder);
          if (reminderTime <= now) {
            if (Notification.permission === "granted") {
              new Notification("Stuff Reminder", {
                body: task.title,
                icon: "â°",
              });
            }
            setTasks((prev) =>
              prev.map((t) =>
                t.id === task.id ? { ...t, reminderShown: true } : t,
              ),
            );
          }
        }
      });
    }, 30000);
    return () => clearInterval(checkReminders);
  }, [tasks]);

  const addTask = (taskData = {}) => {
    if (!newTaskInput.trim() && !taskData.title) return;

    // Parse natural language date/time
    const parsed = parseNaturalLanguageDate(newTaskInput);
    let cleanTitle = newTaskInput;
    let deadline = taskData.deadline || null;

    if (parsed && !taskData.deadline) {
      // Remove the date/time phrase from the title
      cleanTitle = newTaskInput
        .replace(new RegExp(parsed.matchedText, "i"), "")
        .trim();
      deadline = parsed.date.toISOString();
    }

    const newTask = {
      id: Date.now(),
      title: taskData.title || cleanTitle,
      notes: taskData.notes || "",
      completed: false,
      priority: taskData.priority || null,
      when:
        taskData.when ||
        (selectedView === "today"
          ? "today"
          : selectedView === "upcoming"
            ? "upcoming"
            : null),
      projectId:
        taskData.projectId ||
        (selectedView === "project" ? selectedProject : null),
      areaId:
        taskData.areaId || (selectedView === "area" ? selectedArea : null),
      tags: taskData.tags || [],
      checklist: taskData.checklist || [],
      deadline: deadline,
      reminder: taskData.reminder || null,
      recurring: taskData.recurring || null,
      reminderShown: false,
      order: tasks.length,
      createdAt: new Date().toISOString(),
    };
    setTasks([...tasks, newTask]);
    setNewTaskInput("");
    setDetectedDateTime(null);
    setNewlyAddedTaskId(newTask.id);

    // Clear the newly added task ID after animation completes
    setTimeout(() => {
      setNewlyAddedTaskId(null);
    }, 300);
  };

  const updateTask = useCallback(
    (taskId, updates) => {
      setTasks((prevTasks) =>
        prevTasks.map((task) =>
          task.id === taskId ? { ...task, ...updates } : task,
        ),
      );
      if (selectedTask?.id === taskId) {
        setSelectedTask((prev) => ({ ...prev, ...updates }));
      }
    },
    [selectedTask],
  );

  const toggleTaskComplete = useCallback(
    (taskId) => {
      const task = tasks.find((t) => t.id === taskId);
      if (!task) return;

      // If marking as complete and not in logbook view
      if (!task.completed && selectedView !== "logbook") {
        // Play completion sound if enabled
        if (completionSound) {
          const audio = new Audio(
            "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE=",
          );
          audio.volume = 0.3;
          audio.play().catch(() => {});
        }
        // Add to completing animation list
        setCompletingTaskIds((prev) => [...prev, taskId]);

        // After animation, actually complete the task
        setTimeout(() => {
          if (task.recurring) {
            const newTask = createRecurringTask(task);
            setTasks((prev) => [
              ...prev.map((t) =>
                t.id === taskId
                  ? {
                      ...t,
                      completed: true,
                      completedAt: new Date().toISOString(),
                    }
                  : t,
              ),
              newTask,
            ]);
          } else {
            setTasks((prev) =>
              prev.map((t) =>
                t.id === taskId
                  ? {
                      ...t,
                      completed: true,
                      completedAt: new Date().toISOString(),
                    }
                  : t,
              ),
            );
          }
          // Remove from completing list
          setCompletingTaskIds((prev) => prev.filter((id) => id !== taskId));
        }, 600); // Animation duration
      } else {
        // Uncompleting or in logbook view - immediate toggle
        if (task.recurring && !task.completed) {
          const newTask = createRecurringTask(task);
          setTasks((prev) => [
            ...prev.map((t) =>
              t.id === taskId
                ? {
                    ...t,
                    completed: true,
                    completedAt: new Date().toISOString(),
                  }
                : t,
            ),
            newTask,
          ]);
        } else {
          setTasks((prev) =>
            prev.map((t) =>
              t.id === taskId
                ? {
                    ...t,
                    completed: !t.completed,
                    completedAt: !t.completed ? new Date().toISOString() : null,
                  }
                : t,
            ),
          );
        }
      }
    },
    [tasks, selectedView, completionSound],
  );

  const createRecurringTask = (task) => {
    let newDeadline = null;
    if (task.deadline) {
      const deadlineDate = new Date(task.deadline);
      switch (task.recurring) {
        case "daily":
          deadlineDate.setDate(deadlineDate.getDate() + 1);
          break;
        case "weekly":
          deadlineDate.setDate(deadlineDate.getDate() + 7);
          break;
        case "monthly":
          deadlineDate.setMonth(deadlineDate.getMonth() + 1);
          break;
        case "yearly":
          deadlineDate.setFullYear(deadlineDate.getFullYear() + 1);
          break;
      }
      newDeadline = deadlineDate.toISOString();
    }
    return {
      ...task,
      id: Date.now(),
      completed: false,
      deadline: newDeadline,
      reminder: null,
      reminderShown: false,
      completedAt: null,
      order: tasks.length,
      createdAt: new Date().toISOString(),
    };
  };

  const deleteTask = useCallback(
    (taskId) => {
      setTasks((prevTasks) => prevTasks.filter((task) => task.id !== taskId));
      if (selectedTask?.id === taskId) {
        setShowTaskDetail(false);
        setSelectedTask(null);
      }
    },
    [selectedTask],
  );

  const addProject = () => {
    if (!newProjectName.trim()) return;
    const newProject = {
      id: Date.now(),
      name: newProjectName,
      areaId: selectedView === "area" ? selectedArea : null,
      color: "#007AFF",
      emoji: null,
    };
    setProjects([...projects, newProject]);
    setNewProjectName("");
    setShowNewProjectInput(false);
  };

  const deleteProject = (projectId) => {
    setProjects(projects.filter((p) => p.id !== projectId));
    setTasks(
      tasks.map((task) =>
        task.projectId === projectId ? { ...task, projectId: null } : task,
      ),
    );
    if (selectedProject === projectId) {
      setSelectedView("inbox");
      setSelectedProject(null);
    }
  };

  const updateProject = useCallback(
    (projectId, updates) => {
      setProjects(
        projects.map((p) => (p.id === projectId ? { ...p, ...updates } : p)),
      );
    },
    [projects],
  );

  const addArea = () => {
    if (!newAreaName.trim()) return;
    const newArea = { id: Date.now(), name: newAreaName, emoji: null };
    setAreas([...areas, newArea]);
    setNewAreaName("");
    setShowNewAreaInput(false);
  };

  const deleteArea = (areaId) => {
    setAreas(areas.filter((a) => a.id !== areaId));
    setProjects(
      projects.map((project) =>
        project.areaId === areaId ? { ...project, areaId: null } : project,
      ),
    );
    setTasks(
      tasks.map((task) =>
        task.areaId === areaId ? { ...task, areaId: null } : task,
      ),
    );
    if (selectedArea === areaId) {
      setSelectedView("inbox");
      setSelectedArea(null);
    }
  };

  const updateArea = useCallback(
    (areaId, updates) => {
      setAreas(areas.map((a) => (a.id === areaId ? { ...a, ...updates } : a)));
    },
    [areas],
  );

  const toggleAreaExpanded = (areaId) => {
    setExpandedAreas((prev) => ({
      ...prev,
      [areaId]: !prev[areaId],
    }));
  };

  const addTag = () => {
    if (!newTagName.trim()) return;
    if (tags.find((t) => t.name.toLowerCase() === newTagName.toLowerCase())) {
      setNewTagName("");
      return;
    }
    const colors = [
      "#FF3B30",
      "#FF9500",
      "#FFCC00",
      "#34C759",
      "#00C7BE",
      "#30B0C7",
      "#007AFF",
      "#5856D6",
      "#AF52DE",
      "#FF2D55",
    ];
    const newTag = {
      id: Date.now(),
      name: newTagName,
      color: colors[Math.floor(Math.random() * colors.length)],
    };
    setTags([...tags, newTag]);
    setNewTagName("");
  };

  const deleteTag = (tagId) => {
    const tagToDelete = tags.find((t) => t.id === tagId);
    if (!tagToDelete) return;
    setTags(tags.filter((t) => t.id !== tagId));
    setTasks(
      tasks.map((task) => ({
        ...task,
        tags: task.tags.filter((t) => t !== tagToDelete.name),
      })),
    );
  };

  const getFilteredTasks = useMemo(() => {
    let filtered = [...tasks];
    switch (selectedView) {
      case "inbox":
        filtered = tasks.filter(
          (t) => !t.completed && !t.when && !t.projectId && !t.areaId,
        );
        break;
      case "today":
        const today = new Date().toDateString();
        filtered = tasks.filter(
          (t) =>
            !t.completed &&
            (t.when === "today" ||
              (t.deadline && new Date(t.deadline).toDateString() === today)),
        );
        break;
      case "upcoming":
        filtered = tasks.filter(
          (t) =>
            !t.completed &&
            (t.when === "upcoming" ||
              (t.deadline && new Date(t.deadline) > new Date())),
        );
        break;
      case "anytime":
        filtered = tasks.filter((t) => !t.completed && t.when === "anytime");
        break;
      case "someday":
        filtered = tasks.filter((t) => !t.completed && t.when === "someday");
        break;
      case "logbook":
        filtered = tasks.filter((t) => t.completed);
        break;
      case "project":
        if (selectedProject)
          filtered = tasks.filter((t) => t.projectId === selectedProject);
        break;
      case "area":
        if (selectedArea)
          filtered = tasks.filter((t) => t.areaId === selectedArea);
        break;
    }
    return filtered.sort((a, b) => (a.order || 0) - (b.order || 0));
  }, [tasks, selectedView, selectedProject, selectedArea]);

  const getUpcomingTasksByDate = () => {
    const upcomingTasks = tasks.filter(
      (t) =>
        !t.completed &&
        (t.when === "upcoming" ||
          (t.deadline && new Date(t.deadline) > new Date())),
    );
    const grouped = {};
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let i = 0; i < 60; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dateKey = date.toDateString();
      grouped[dateKey] = {
        tasks: [],
        sortKey: date.getTime(),
        isEmpty: true,
        dateObj: date,
      };
    }

    upcomingTasks.forEach((task) => {
      if (task.deadline) {
        const date = new Date(task.deadline);
        date.setHours(0, 0, 0, 0);
        const dateKey = date.toDateString();
        if (grouped[dateKey]) {
          grouped[dateKey].tasks.push(task);
          grouped[dateKey].isEmpty = false;
        }
      }
    });

    return Object.entries(grouped)
      .sort(([, a], [, b]) => a.sortKey - b.sortKey)
      .map(([date, data]) => ({
        date,
        tasks: data.tasks.sort((a, b) => (a.order || 0) - (b.order || 0)),
        isEmpty: data.isEmpty,
        dateObj: data.dateObj,
      }));
  };

  const formatDateHeader = (dateObj) => {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    const dayOfMonth = dateObj.getDate();
    const dayName = dateObj.toLocaleDateString("en-US", { weekday: "short" });
    const monthName = dateObj.toLocaleDateString("en-US", { month: "long" });
    const year = dateObj.getFullYear();

    let label = dayName;
    if (dateObj.toDateString() === today.toDateString()) {
      label = "Today";
    } else if (dateObj.toDateString() === tomorrow.toDateString()) {
      label = "Tomorrow";
    }

    return {
      day: dayOfMonth,
      label,
      month: monthName,
      year,
      isToday: dateObj.toDateString() === today.toDateString(),
    };
  };

  const handleDragStart = (e, task) => {
    setDraggedTask(task);
    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData("text/plain", task.id);
    // Make drag more reliable
    if (e.currentTarget) {
      e.currentTarget.style.opacity = "0.5";
    }
  };

  const handleDragOver = (e, task) => {
    e.preventDefault();
    e.stopPropagation();
    if (!draggedTask || draggedTask.id === task.id) return;
    setDragOverTask(task);
  };

  const handleDrop = (e, targetTask) => {
    e.preventDefault();
    e.stopPropagation();

    if (!draggedTask || draggedTask.id === targetTask.id) {
      setDraggedTask(null);
      setDragOverTask(null);
      return;
    }

    const filtered = [...getFilteredTasks];
    const fromIndex = filtered.findIndex((t) => t.id === draggedTask.id);
    const toIndex = filtered.findIndex((t) => t.id === targetTask.id);

    if (fromIndex === -1 || toIndex === -1) {
      setDraggedTask(null);
      setDragOverTask(null);
      return;
    }

    const reordered = [...filtered];
    reordered.splice(fromIndex, 1);
    reordered.splice(toIndex, 0, draggedTask);

    const updates = {};
    reordered.forEach((t, idx) => {
      updates[t.id] = idx;
    });

    setTasks(
      tasks.map((t) =>
        updates.hasOwnProperty(t.id) ? { ...t, order: updates[t.id] } : t,
      ),
    );

    setDraggedTask(null);
    setDragOverTask(null);
  };

  const handleDragEnd = (e) => {
    if (e.currentTarget) {
      e.currentTarget.style.opacity = "";
    }
    setDraggedTask(null);
    setDragOverTask(null);
  };

  const handleProjectDragStart = (e, project) => {
    setDraggedProject(project);
    e.dataTransfer.effectAllowed = "move";
  };

  const handleProjectDragOverProject = (e, project) => {
    e.preventDefault();
    if (!draggedProject || draggedProject.id === project.id) return;
    setDragOverProject(project);
    setDragOverArea(null);
  };

  const handleProjectDragOverArea = (e, area) => {
    e.preventDefault();
    if (!draggedProject) return;
    setDragOverArea(area);
    setDragOverProject(null);
  };

  const handleProjectDropOnProject = (e, targetProject) => {
    e.preventDefault();
    if (!draggedProject || draggedProject.id === targetProject.id) return;

    const draggedIndex = projects.findIndex((p) => p.id === draggedProject.id);
    const targetIndex = projects.findIndex((p) => p.id === targetProject.id);

    if (draggedIndex === -1 || targetIndex === -1) return;

    const newProjects = [...projects];
    newProjects.splice(draggedIndex, 1);
    newProjects.splice(targetIndex, 0, draggedProject);

    setProjects(newProjects);
    setDraggedProject(null);
    setDragOverProject(null);
  };

  const handleProjectDropOnArea = (e, area) => {
    e.preventDefault();
    if (!draggedProject) return;

    updateProject(draggedProject.id, { areaId: area.id });
    setDraggedProject(null);
    setDragOverArea(null);
  };

  const handleProjectDragEnd = () => {
    setDraggedProject(null);
    setDragOverProject(null);
    setDragOverArea(null);
  };

  const TaskItem = React.memo(({ task }) => {
    const isCompleting = completingTaskIds.includes(task.id);

    return (
      <div
        style={{
          marginBottom: "10px",
        }}
      >
        <div
          onClick={() => {
            if (!isCompleting) {
              setSelectedTask(task);
              setShowTaskDetail(true);
            }
          }}
          onContextMenu={(e) => {
            e.preventDefault();
            setContextMenu({
              x: e.clientX,
              y: e.clientY,
              task: task,
            });
          }}
          style={{
            backgroundColor: isDarkMode ? "#2a2a2a" : "white",
            borderRadius: "50px",
            border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #F2F2F7",
            boxShadow: "0 2px 8px rgba(0, 0, 0, 0.04)",
            padding: "12px 20px",
            animation: isCompleting
              ? "taskComplete 0.6s ease-out forwards"
              : "none",
            maxWidth: showTaskDetail ? "calc(100% - 440px)" : "100%",
            transition: "max-width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)",
          }}
          className={`group flex items-center gap-3 ${!isCompleting ? "cursor-pointer" : ""} transition-smooth hover:shadow-lg ${newlyAddedTaskId === task.id ? "animate-fade-in-up" : ""}`}
        >
          <div className="flex-1 min-w-0 flex items-center gap-3">
            <button
              onClick={(e) => {
                e.stopPropagation();
                toggleTaskComplete(task.id);
              }}
              className="flex-shrink-0 transition-smooth "
            >
              {task.completed || isCompleting ? (
                <CheckCircle2
                  style={{
                    color: "#34C759",
                    animation: isCompleting
                      ? "checkmarkPop 0.3s ease-out"
                      : "none",
                  }}
                  className="w-5 h-5"
                />
              ) : (
                <Circle
                  style={{ color: "#C7C7CC" }}
                  className="w-5 h-5 hover:text-[#007AFF]"
                />
              )}
            </button>
            <div className="flex-1 min-w-0 flex items-center gap-2">
              <div
                style={{
                  color:
                    task.completed || isCompleting
                      ? "#8E8E93"
                      : isDarkMode
                        ? "#ffffff"
                        : "#1C1C1E",
                }}
                className={`text-sm ${task.completed || isCompleting ? "line-through" : ""}`}
              >
                {task.title}
              </div>
              {(task.priority ||
                task.deadline ||
                task.reminder ||
                task.recurring ||
                (task.checklist && task.checklist.length > 0) ||
                (task.tags && task.tags.length > 0)) && (
                <div className="flex flex-wrap gap-1.5 items-center">
                  {task.priority && (
                    <span
                      style={{
                        color:
                          task.priority === "high"
                            ? "#FF3B30"
                            : task.priority === "medium"
                              ? "#FF9500"
                              : "#007AFF",
                        backgroundColor:
                          task.priority === "high"
                            ? "#FF3B3015"
                            : task.priority === "medium"
                              ? "#FF950015"
                              : "#007AFF15",
                        fontSize: "10px",
                        fontWeight: "700",
                        textTransform: "uppercase",
                        letterSpacing: "0.5px",
                      }}
                      className="px-2 py-0.5 rounded-full"
                    >
                      {task.priority === "high"
                        ? "!!!"
                        : task.priority === "medium"
                          ? "!!"
                          : "!"}
                    </span>
                  )}
                  {task.deadline && (
                    <span
                      style={{
                        color: "#FF9500",
                        backgroundColor: "#FF950010",
                        fontSize: "11px",
                      }}
                      className="flex items-center gap-1 px-2 py-0.5 rounded-full"
                    >
                      <Clock className="w-2.5 h-2.5" />
                      {new Date(task.deadline).toLocaleDateString()}
                    </span>
                  )}
                  {task.reminder && !task.reminderShown && (
                    <span
                      style={{
                        color: "#AF52DE",
                        backgroundColor: "#AF52DE10",
                        fontSize: "11px",
                      }}
                      className="flex items-center gap-1 px-2 py-0.5 rounded-full"
                    >
                      <Bell className="w-2.5 h-2.5" />
                    </span>
                  )}
                  {task.recurring && (
                    <span
                      style={{
                        color: "#34C759",
                        backgroundColor: "#34C75910",
                        fontSize: "11px",
                      }}
                      className="flex items-center gap-1 px-2 py-0.5 rounded-full"
                    >
                      <Repeat className="w-2.5 h-2.5" />
                    </span>
                  )}
                  {task.checklist && task.checklist.length > 0 && (
                    <span
                      style={{
                        color: "#8E8E93",
                        backgroundColor: "#8E8E9310",
                        fontSize: "11px",
                      }}
                      className="px-2 py-0.5 rounded-full"
                    >
                      {task.checklist.filter((item) => item.completed).length}/
                      {task.checklist.length}
                    </span>
                  )}
                  {task.tags &&
                    task.tags.map((tagName) => {
                      const tag = tags.find((t) => t.name === tagName);
                      return (
                        <span
                          key={tagName}
                          style={{
                            backgroundColor: tag
                              ? tag.color + "15"
                              : "#cccccc15",
                            color: tag ? tag.color : "#666666",
                            fontSize: "11px",
                          }}
                          className="px-2 py-0.5 rounded-full"
                        >
                          {tagName}
                        </span>
                      );
                    })}
                </div>
              )}
            </div>
          </div>
          <button
            onClick={(e) => {
              e.stopPropagation();
              if (
                (showConfirmDialogs &&
                  confirm(`Delete task "${task.title}"?`)) ||
                !showConfirmDialogs
              ) {
                deleteTask(task.id);
              }
            }}
            className="opacity-0 group-hover:opacity-100 transition-smooth flex-shrink-0 "
          >
            <Trash2
              style={{ color: "#8E8E93" }}
              className="w-4 h-4 hover:text-[#FF3B30]"
            />
          </button>
        </div>
      </div>
    );
  });

  const TaskDetailPanel = React.memo(() => {
    if (!showTaskDetail || !selectedTask) return null;
    const task = tasks.find((t) => t.id === selectedTask.id);
    if (!task) return null;

    const taskIdRef = React.useRef(selectedTask.id);
    const [hasAnimated, setHasAnimated] = React.useState(false);
    const [localTitle, setLocalTitle] = React.useState(task.title);
    const [localNotes, setLocalNotes] = React.useState(task.notes || "");
    const [localPriority, setLocalPriority] = React.useState(
      task.priority || "",
    );
    const [localChecklist, setLocalChecklist] = React.useState(
      task.checklist || [],
    );
    const [localDeadline, setLocalDeadline] = React.useState(
      task.deadline || "",
    );
    const [localReminder, setLocalReminder] = React.useState(
      task.reminder || "",
    );
    const [localRecurring, setLocalRecurring] = React.useState(
      task.recurring || "",
    );
    const [localWhen, setLocalWhen] = React.useState(task.when || "");
    const [localProjectId, setLocalProjectId] = React.useState(
      task.projectId || "",
    );
    const [localAreaId, setLocalAreaId] = React.useState(task.areaId || "");

    // Set hasAnimated on first render
    React.useEffect(() => {
      if (!hasAnimated) {
        setHasAnimated(true);
      }
    }, []);

    // Only reset local state when task ID changes (switching to different task)
    React.useEffect(() => {
      if (taskIdRef.current !== selectedTask.id) {
        setHasAnimated(false);
        setLocalTitle(task.title);
        setLocalNotes(task.notes || "");
        setLocalPriority(task.priority || "");
        setLocalChecklist(task.checklist || []);
        setLocalDeadline(task.deadline || "");
        setLocalReminder(task.reminder || "");
        setLocalRecurring(task.recurring || "");
        setLocalWhen(task.when || "");
        setLocalProjectId(task.projectId || "");
        setLocalAreaId(task.areaId || "");
        taskIdRef.current = selectedTask.id;
      }
    }, [selectedTask.id]);

    const handleTitleBlur = () => {
      if (localTitle !== task.title) {
        updateTask(task.id, { title: localTitle });
      }
    };

    const handleNotesBlur = () => {
      if (localNotes !== (task.notes || "")) {
        updateTask(task.id, { notes: localNotes });
      }
    };

    const handleChecklistChange = (index, field, value) => {
      const newChecklist = [...localChecklist];
      newChecklist[index] = { ...newChecklist[index], [field]: value };
      setLocalChecklist(newChecklist);
    };

    const handleChecklistBlur = () => {
      updateTask(task.id, { checklist: localChecklist });
    };

    const handleChecklistToggle = (index) => {
      const newChecklist = [...localChecklist];
      newChecklist[index] = {
        ...newChecklist[index],
        completed: !newChecklist[index].completed,
      };
      setLocalChecklist(newChecklist);
      updateTask(task.id, { checklist: newChecklist });
    };

    const handleAddChecklistItem = () => {
      const newChecklist = [...localChecklist, { text: "", completed: false }];
      setLocalChecklist(newChecklist);
    };

    const handleDeleteChecklistItem = (index) => {
      const newChecklist = localChecklist.filter((_, i) => i !== index);
      setLocalChecklist(newChecklist);
      updateTask(task.id, { checklist: newChecklist });
    };

    return (
      <>
        {/* Backdrop to close when clicking outside */}
        <div
          className="fixed inset-0 bg-transparent z-30"
          onClick={() => {
            setShowTaskDetail(false);
            setSelectedTask(null);
          }}
        />
        <div
          style={{
            backgroundColor: isDarkMode ? "#252525" : "white",
            width: "420px",
            boxShadow: "-4px 0 24px rgba(0, 0, 0, 0.08)",
            position: "fixed",
            top: 0,
            right: 0,
            bottom: 0,
          }}
          className={`flex flex-col z-40 ${!hasAnimated ? "animate-slide-in-right" : ""}`}
        >
          <div
            style={{
              borderBottom: isDarkMode
                ? "1px solid #2a2a2a"
                : "1px solid #E5E5E5",
              background: isDarkMode
                ? "linear-gradient(to bottom, #252525, #252525)"
                : "linear-gradient(to bottom, #FAFAFA, #FFFFFF)",
              borderTopLeftRadius: "20px",
              borderTopRightRadius: "20px",
            }}
            className="px-6 py-5 flex items-center justify-between"
          >
            <h3
              style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
              className="text-lg font-semibold"
            >
              Task Details
            </h3>
            <button
              onClick={() => {
                setShowTaskDetail(false);
                setSelectedTask(null);
              }}
              style={{ color: "#8E8E93" }}
              className="hover:text-[#1C1C1E] transition-smooth "
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          <div className="flex-1 overflow-y-auto p-6 space-y-4">
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <label
                style={{ color: "#8E8E93" }}
                className="text-xs font-semibold uppercase block mb-2"
              >
                Title
              </label>
              <input
                type="text"
                value={localTitle}
                onChange={(e) => setLocalTitle(e.target.value)}
                onBlur={handleTitleBlur}
                style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                className="w-full text-sm outline-none bg-transparent"
              />
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <label
                style={{ color: "#8E8E93" }}
                className="text-xs font-semibold uppercase block mb-2"
              >
                Priority
              </label>
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    setLocalPriority(localPriority === "high" ? "" : "high");
                    updateTask(task.id, {
                      priority: localPriority === "high" ? null : "high",
                    });
                  }}
                  style={{
                    flex: 1,
                    padding: "8px 12px",
                    borderRadius: "10px",
                    border:
                      localPriority === "high"
                        ? "2px solid #FF3B30"
                        : isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                    backgroundColor:
                      localPriority === "high"
                        ? "#FF3B3015"
                        : isDarkMode
                          ? "#1a1a1a"
                          : "white",
                    color: localPriority === "high" ? "#FF3B30" : "#8E8E93",
                    fontSize: "13px",
                    fontWeight: "600",
                  }}
                  className="hover:bg-[#FF3B3010] transition-smooth"
                >
                  High
                </button>
                <button
                  onClick={() => {
                    setLocalPriority(
                      localPriority === "medium" ? "" : "medium",
                    );
                    updateTask(task.id, {
                      priority: localPriority === "medium" ? null : "medium",
                    });
                  }}
                  style={{
                    flex: 1,
                    padding: "8px 12px",
                    borderRadius: "10px",
                    border:
                      localPriority === "medium"
                        ? "2px solid #FF9500"
                        : isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                    backgroundColor:
                      localPriority === "medium"
                        ? "#FF950015"
                        : isDarkMode
                          ? "#1a1a1a"
                          : "white",
                    color: localPriority === "medium" ? "#FF9500" : "#8E8E93",
                    fontSize: "13px",
                    fontWeight: "600",
                  }}
                  className="hover:bg-[#FF950010] transition-smooth"
                >
                  Medium
                </button>
                <button
                  onClick={() => {
                    setLocalPriority(localPriority === "low" ? "" : "low");
                    updateTask(task.id, {
                      priority: localPriority === "low" ? null : "low",
                    });
                  }}
                  style={{
                    flex: 1,
                    padding: "8px 12px",
                    borderRadius: "10px",
                    border:
                      localPriority === "low"
                        ? "2px solid #007AFF"
                        : isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                    backgroundColor:
                      localPriority === "low"
                        ? "#007AFF15"
                        : isDarkMode
                          ? "#1a1a1a"
                          : "white",
                    color: localPriority === "low" ? "#007AFF" : "#8E8E93",
                    fontSize: "13px",
                    fontWeight: "600",
                  }}
                  className="hover:bg-[#007AFF10] transition-smooth"
                >
                  Low
                </button>
              </div>
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <div className="flex items-center gap-2 mb-2">
                <StickyNote style={{ color: "#8E8E93" }} className="w-4 h-4" />
                <label
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Notes
                </label>
              </div>
              <textarea
                value={localNotes}
                onChange={(e) => setLocalNotes(e.target.value)}
                onBlur={handleNotesBlur}
                style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                className="w-full text-sm outline-none bg-transparent resize-none"
                placeholder="Add notes..."
                rows="3"
              />
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <div className="flex items-center gap-2 mb-2">
                <Clock style={{ color: "#FF9500" }} className="w-4 h-4" />
                <label
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Deadline
                </label>
              </div>
              <DateTimePicker
                value={localDeadline}
                onChange={(newValue) => {
                  setLocalDeadline(newValue);
                  updateTask(task.id, { deadline: newValue || null });
                }}
                placeholder="Set deadline"
                timeFormat={timeFormat}
                isDarkMode={isDarkMode}
              />
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <div className="flex items-center gap-2 mb-2">
                <Bell style={{ color: "#AF52DE" }} className="w-4 h-4" />
                <label
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Reminder
                </label>
              </div>
              <DateTimePicker
                value={localReminder}
                onChange={(newValue) => {
                  setLocalReminder(newValue);
                  updateTask(task.id, {
                    reminder: newValue || null,
                    reminderShown: false,
                  });
                }}
                placeholder="Set reminder"
                timeFormat={timeFormat}
                isDarkMode={isDarkMode}
              />
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <div className="flex items-center gap-2 mb-2">
                <Repeat style={{ color: "#34C759" }} className="w-4 h-4" />
                <label
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Recurring
                </label>
              </div>
              <select
                value={localRecurring}
                onChange={(e) => {
                  setLocalRecurring(e.target.value);
                  updateTask(task.id, { recurring: e.target.value || null });
                }}
                style={{
                  color: isDarkMode ? "#ffffff" : "#1C1C1E",
                  borderRadius: "8px",
                  border: isDarkMode
                    ? "1px solid #3a3a3a"
                    : "1px solid #E5E5E5",
                  backgroundColor: isDarkMode ? "#252525" : "white",
                }}
                className="w-full px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
              >
                <option value="">None</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <div className="flex items-center gap-2 mb-2">
                <Calendar style={{ color: "#007AFF" }} className="w-4 h-4" />
                <label
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  When
                </label>
              </div>
              <select
                value={localWhen}
                onChange={(e) => {
                  setLocalWhen(e.target.value);
                  updateTask(task.id, { when: e.target.value || null });
                }}
                style={{
                  color: isDarkMode ? "#ffffff" : "#1C1C1E",
                  borderRadius: "8px",
                  border: isDarkMode
                    ? "1px solid #3a3a3a"
                    : "1px solid #E5E5E5",
                  backgroundColor: isDarkMode ? "#252525" : "white",
                }}
                className="w-full px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
              >
                <option value="">None</option>
                <option value="today">Today</option>
                <option value="upcoming">Upcoming</option>
                <option value="anytime">Anytime</option>
                <option value="someday">Someday</option>
              </select>
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <div className="flex items-center gap-2 mb-2">
                <List style={{ color: "#007AFF" }} className="w-4 h-4" />
                <label
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Project
                </label>
              </div>
              <select
                value={localProjectId}
                onChange={(e) => {
                  setLocalProjectId(e.target.value);
                  updateTask(task.id, {
                    projectId: e.target.value ? parseInt(e.target.value) : null,
                  });
                }}
                style={{
                  color: isDarkMode ? "#ffffff" : "#1C1C1E",
                  borderRadius: "8px",
                  border: isDarkMode
                    ? "1px solid #3a3a3a"
                    : "1px solid #E5E5E5",
                  backgroundColor: isDarkMode ? "#252525" : "white",
                }}
                className="w-full px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
              >
                <option value="">None</option>
                {projects.map((project) => (
                  <option key={project.id} value={project.id}>
                    {project.name}
                  </option>
                ))}
              </select>
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <div className="flex items-center gap-2 mb-2">
                <Tag style={{ color: "#FF2D55" }} className="w-4 h-4" />
                <label
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Area
                </label>
              </div>
              <select
                value={localAreaId}
                onChange={(e) => {
                  setLocalAreaId(e.target.value);
                  updateTask(task.id, {
                    areaId: e.target.value ? parseInt(e.target.value) : null,
                  });
                }}
                style={{
                  color: isDarkMode ? "#ffffff" : "#1C1C1E",
                  borderRadius: "8px",
                  border: isDarkMode
                    ? "1px solid #3a3a3a"
                    : "1px solid #E5E5E5",
                  backgroundColor: isDarkMode ? "#252525" : "white",
                }}
                className="w-full px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
              >
                <option value="">None</option>
                {areas.map((area) => (
                  <option key={area.id} value={area.id}>
                    {area.name}
                  </option>
                ))}
              </select>
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <div className="flex items-center gap-2 mb-2">
                <Tag style={{ color: "#FF2D55" }} className="w-4 h-4" />
                <label
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Tags
                </label>
              </div>
              <div className="flex flex-wrap gap-2 mb-2">
                {task.tags &&
                  task.tags.map((tagName) => {
                    const tag = tags.find((t) => t.name === tagName);
                    return (
                      <span
                        key={tagName}
                        className="text-xs px-3 py-1 rounded-full flex items-center gap-1"
                        style={{
                          backgroundColor: tag ? tag.color + "20" : "#cccccc20",
                          color: tag ? tag.color : "#666666",
                        }}
                      >
                        {tagName}
                        <button
                          onClick={() =>
                            updateTask(task.id, {
                              tags: task.tags.filter((t) => t !== tagName),
                            })
                          }
                          className="hover:text-[#FF3B30]"
                        >
                          <X className="w-3 h-3" />
                        </button>
                      </span>
                    );
                  })}
              </div>
              <select
                value=""
                onChange={(e) => {
                  if (e.target.value && !task.tags.includes(e.target.value))
                    updateTask(task.id, {
                      tags: [...(task.tags || []), e.target.value],
                    });
                }}
                style={{
                  color: isDarkMode ? "#ffffff" : "#1C1C1E",
                  borderRadius: "8px",
                  border: isDarkMode
                    ? "1px solid #3a3a3a"
                    : "1px solid #E5E5E5",
                  backgroundColor: isDarkMode ? "#252525" : "white",
                }}
                className="w-full px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
              >
                <option value="">Add tag...</option>
                {tags
                  .filter((t) => !task.tags || !task.tags.includes(t.name))
                  .map((tag) => (
                    <option key={tag.id} value={tag.name}>
                      {tag.name}
                    </option>
                  ))}
              </select>
            </div>
            <div
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "#FAFAFA",
                borderRadius: "16px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              }}
              className="p-4 shadow-sm hover:shadow-md transition-smooth"
            >
              <div className="flex items-center gap-2 mb-2">
                <CheckCircle2
                  style={{ color: "#34C759" }}
                  className="w-4 h-4"
                />
                <label
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Checklist
                </label>
              </div>
              <div className="space-y-2">
                {localChecklist &&
                  localChecklist.map((item, index) => (
                    <div key={index} className="flex items-center gap-2">
                      <button
                        onClick={() => handleChecklistToggle(index)}
                        className="flex-shrink-0"
                      >
                        {item.completed ? (
                          <CheckCircle2
                            style={{ color: "#007AFF" }}
                            className="w-4 h-4"
                          />
                        ) : (
                          <Circle
                            style={{ color: "#C7C7CC" }}
                            className="w-4 h-4"
                          />
                        )}
                      </button>
                      <input
                        type="text"
                        value={item.text}
                        onChange={(e) =>
                          handleChecklistChange(index, "text", e.target.value)
                        }
                        onBlur={handleChecklistBlur}
                        style={{
                          color: item.completed
                            ? "#8E8E93"
                            : isDarkMode
                              ? "#ffffff"
                              : "#1C1C1E",
                        }}
                        className={`flex-1 px-2 py-1 text-sm border-0 outline-none bg-transparent ${item.completed ? "line-through" : ""}`}
                        placeholder="Checklist item..."
                      />
                      <button
                        onClick={() => handleDeleteChecklistItem(index)}
                        style={{ color: "#8E8E93" }}
                        className="hover:text-[#FF3B30] flex-shrink-0"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                <button
                  onClick={handleAddChecklistItem}
                  style={{ color: "#007AFF" }}
                  className="text-sm hover:text-[#0051D5] flex items-center gap-1 mt-2"
                >
                  <Plus className="w-4 h-4" />
                  Add item
                </button>
              </div>
            </div>
          </div>
        </div>
      </>
    );
  });

  const TagManagementPanel = React.memo(() => {
    const [hasAnimated, setHasAnimated] = React.useState(false);
    const [localTagName, setLocalTagName] = React.useState("");

    React.useEffect(() => {
      if (showTagPanel && !hasAnimated) {
        setHasAnimated(true);
      }
    }, [showTagPanel, hasAnimated]);

    React.useEffect(() => {
      if (!showTagPanel) {
        setHasAnimated(false);
        setLocalTagName("");
      }
    }, [showTagPanel]);

    if (!showTagPanel) return null;

    const closePanel = () => {
      setTagPanelClosing(true);
      setTimeout(() => {
        setShowTagPanel(false);
        setTagPanelClosing(false);
      }, 200);
    };

    const handleAddTag = () => {
      if (!localTagName.trim()) return;
      if (
        tags.find((t) => t.name.toLowerCase() === localTagName.toLowerCase())
      ) {
        setLocalTagName("");
        return;
      }
      const colors = [
        "#FF3B30",
        "#FF9500",
        "#FFCC00",
        "#34C759",
        "#00C7BE",
        "#30B0C7",
        "#007AFF",
        "#5856D6",
        "#AF52DE",
        "#FF2D55",
      ];
      const newTag = {
        id: Date.now(),
        name: localTagName,
        color: colors[Math.floor(Math.random() * colors.length)],
      };
      setTags([...tags, newTag]);
      setLocalTagName("");
    };

    return (
      <div
        className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ${tagPanelClosing ? "animate-fade-out" : !hasAnimated ? "animate-fade-in-up" : ""}`}
        onClick={closePanel}
      >
        <div
          style={{
            backgroundColor: "white",
            borderRadius: "20px",
            width: "480px",
            maxHeight: "80vh",
          }}
          className={`shadow-2xl flex flex-col ${tagPanelClosing ? "animate-bounce-out" : !hasAnimated ? "animate-bounce-in" : ""}`}
          onClick={(e) => e.stopPropagation()}
        >
          <div
            style={{ borderBottom: "1px solid #E5E5E5" }}
            className="px-6 py-5 flex items-center justify-between"
          >
            <h3 style={{ color: "#1C1C1E" }} className="text-xl font-semibold">
              Tags
            </h3>
            <button
              onClick={closePanel}
              style={{ color: "#8E8E93" }}
              className="hover:text-[#1C1C1E] transition-smooth "
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          <div
            style={{ borderBottom: "1px solid #E5E5E5" }}
            className="px-6 py-4"
          >
            <div className="flex gap-2">
              <input
                type="text"
                value={localTagName}
                onChange={(e) => setLocalTagName(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === "Enter") handleAddTag();
                }}
                placeholder="New tag name"
                style={{
                  color: "#1C1C1E",
                  borderRadius: "12px",
                  border: "1px solid #E5E5E5",
                  backgroundColor: "#FAFAFA",
                }}
                className="flex-1 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF] transition-smooth"
              />
              <button
                onClick={handleAddTag}
                style={{ backgroundColor: "#007AFF", borderRadius: "12px" }}
                className="px-5 py-2.5 text-white hover:bg-[#0051D5] text-sm font-medium transition-smooth "
              >
                Add
              </button>
            </div>
          </div>
          <div className="flex-1 overflow-y-auto px-6 py-4">
            {tags.length === 0 ? (
              <div className="text-center py-16">
                <Tag
                  style={{ color: "#C7C7CC" }}
                  className="w-16 h-16 mx-auto mb-4"
                />
                <p style={{ color: "#8E8E93" }} className="text-base">
                  No tags yet
                </p>
                <p style={{ color: "#C7C7CC" }} className="text-sm mt-1">
                  Create tags to organize your tasks
                </p>
              </div>
            ) : (
              <div className="space-y-2">
                {tags.map((tag) => (
                  <div
                    key={tag.id}
                    style={{
                      backgroundColor: "#FAFAFA",
                      borderRadius: "12px",
                      border: "1px solid #E5E5E5",
                    }}
                    className="flex items-center justify-between p-3 hover:bg-[#F5F5F5] transition-smooth animate-scale-in group"
                  >
                    <div className="flex items-center gap-3 flex-1 min-w-0">
                      <div
                        className="w-4 h-4 rounded-full flex-shrink-0"
                        style={{ backgroundColor: tag.color }}
                      />
                      <span
                        style={{ color: "#1C1C1E" }}
                        className="text-sm font-medium truncate"
                      >
                        {tag.name}
                      </span>
                    </div>
                    <div className="flex items-center gap-2 flex-shrink-0">
                      <span
                        style={{ color: "#8E8E93", backgroundColor: "#F0F0F5" }}
                        className="text-xs px-2.5 py-1 rounded-full font-medium"
                      >
                        {
                          tasks.filter(
                            (t) => t.tags && t.tags.includes(tag.name),
                          ).length
                        }
                      </span>
                      <button
                        onClick={() => {
                          if (confirm(`Delete tag "${tag.name}"?`))
                            deleteTag(tag.id);
                        }}
                        style={{ color: "#8E8E93" }}
                        className="opacity-0 group-hover:opacity-100 hover:text-[#FF3B30] transition-smooth  p-1"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  });

  const ProjectManagementPanel = React.memo(() => {
    const [hasAnimated, setHasAnimated] = React.useState(false);

    React.useEffect(() => {
      if (showProjectPanel && !hasAnimated) {
        setHasAnimated(true);
      }
    }, [showProjectPanel, hasAnimated]);

    React.useEffect(() => {
      if (!showProjectPanel) {
        setHasAnimated(false);
      }
    }, [showProjectPanel]);

    if (!showProjectPanel) return null;

    const closePanel = () => {
      setProjectPanelClosing(true);
      setTimeout(() => {
        setShowProjectPanel(false);
        setProjectPanelClosing(false);
      }, 200);
    };

    return (
      <div
        className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ${projectPanelClosing ? "animate-fade-out" : !hasAnimated ? "animate-fade-in-up" : ""}`}
        onClick={closePanel}
      >
        <div
          style={{
            backgroundColor: "white",
            borderRadius: "20px",
            width: "560px",
            maxHeight: "80vh",
          }}
          className={`shadow-2xl flex flex-col ${projectPanelClosing ? "animate-bounce-out" : !hasAnimated ? "animate-bounce-in" : ""}`}
          onClick={(e) => e.stopPropagation()}
        >
          <div
            style={{ borderBottom: "1px solid #E5E5E5" }}
            className="px-6 py-5 flex items-center justify-between"
          >
            <h3 style={{ color: "#1C1C1E" }} className="text-xl font-semibold">
              Projects
            </h3>
            <button
              onClick={closePanel}
              style={{ color: "#8E8E93" }}
              className="hover:text-[#1C1C1E] transition-smooth "
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          <div className="flex-1 overflow-y-auto p-6">
            {projects.length === 0 ? (
              <div className="text-center py-16">
                <List
                  style={{ color: "#C7C7CC" }}
                  className="w-16 h-16 mx-auto mb-4"
                />
                <p style={{ color: "#8E8E93" }} className="text-base">
                  No projects yet
                </p>
                <p style={{ color: "#C7C7CC" }} className="text-sm mt-1">
                  Create a project to organize your tasks
                </p>
              </div>
            ) : (
              <div className="space-y-3">
                {projects.map((project) => (
                  <div
                    key={project.id}
                    style={{
                      backgroundColor: "#FAFAFA",
                      borderRadius: "16px",
                      border: "1px solid #E5E5E5",
                    }}
                    className="p-4 hover:bg-[#F5F5F5] transition-smooth animate-scale-in group"
                  >
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-3 flex-1">
                        <div
                          className="w-4 h-4 rounded-full flex-shrink-0"
                          style={{ backgroundColor: project.color }}
                        />
                        <span
                          style={{ color: "#1C1C1E" }}
                          className="text-base font-medium"
                        >
                          {project.name}
                        </span>
                      </div>
                      <div className="flex items-center gap-3">
                        <span
                          style={{
                            color: "#8E8E93",
                            backgroundColor: "#F0F0F5",
                          }}
                          className="text-xs px-2.5 py-1 rounded-full font-medium"
                        >
                          {
                            tasks.filter(
                              (t) => t.projectId === project.id && !t.completed,
                            ).length
                          }{" "}
                          {tasks.filter(
                            (t) => t.projectId === project.id && !t.completed,
                          ).length === 1
                            ? "task"
                            : "tasks"}
                        </span>
                        <button
                          onClick={() => {
                            if (
                              confirm(
                                `Delete "${project.name}"?\n\nTasks in this project will be moved to Inbox.`,
                              )
                            )
                              deleteProject(project.id);
                          }}
                          style={{ color: "#8E8E93" }}
                          className="opacity-0 group-hover:opacity-100 hover:text-[#FF3B30] transition-smooth  p-1"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                    <div>
                      <label
                        style={{ color: "#8E8E93" }}
                        className="text-xs font-semibold uppercase block mb-2"
                      >
                        Area
                      </label>
                      <select
                        value={project.areaId || ""}
                        onChange={(e) =>
                          updateProject(project.id, {
                            areaId: e.target.value
                              ? parseInt(e.target.value)
                              : null,
                          })
                        }
                        style={{
                          color: "#1C1C1E",
                          borderRadius: "10px",
                          border: "1px solid #E5E5E5",
                          backgroundColor: "white",
                        }}
                        className="w-full px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF] transition-smooth"
                      >
                        <option value="">None</option>
                        {areas.map((area) => (
                          <option key={area.id} value={area.id}>
                            {area.name}
                          </option>
                        ))}
                      </select>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  });

  const QuickFindPanel = React.memo(() => {
    const [hasAnimated, setHasAnimated] = React.useState(false);
    const [localSearch, setLocalSearch] = React.useState("");

    React.useEffect(() => {
      if (showQuickFind && !hasAnimated) {
        setHasAnimated(true);
      }
    }, [showQuickFind, hasAnimated]);

    React.useEffect(() => {
      if (!showQuickFind) {
        setHasAnimated(false);
        setLocalSearch("");
      }
    }, [showQuickFind]);

    if (!showQuickFind) return null;

    const closeQuickFind = () => {
      setQuickFindClosing(true);
      setTimeout(() => {
        setShowQuickFind(false);
        setQuickFindClosing(false);
      }, 200);
    };

    const searchLower = localSearch.toLowerCase();
    const filteredTasks = localSearch
      ? tasks.filter(
          (t) =>
            t.title.toLowerCase().includes(searchLower) ||
            (t.notes && t.notes.toLowerCase().includes(searchLower)) ||
            (t.tags &&
              t.tags.some((tag) => tag.toLowerCase().includes(searchLower))),
        )
      : [];

    const filteredProjects = localSearch
      ? projects.filter((p) => p.name.toLowerCase().includes(searchLower))
      : [];

    const filteredAreas = localSearch
      ? areas.filter((a) => a.name.toLowerCase().includes(searchLower))
      : [];

    const recentViews = [
      {
        name: "Upcoming",
        icon: <Calendar className="w-5 h-5" />,
        color: "#FF3B30",
        view: "upcoming",
      },
      {
        name: "Today",
        icon: <Star className="w-5 h-5" />,
        color: "#FFC107",
        view: "today",
      },
      {
        name: "Logbook",
        icon: <CheckCircle2 className="w-5 h-5" />,
        color: "#34C759",
        view: "logbook",
      },
      {
        name: "Inbox",
        icon: <Inbox className="w-5 h-5" />,
        color: "#007AFF",
        view: "inbox",
      },
      {
        name: "Someday",
        icon: <ChevronRight className="w-5 h-5" />,
        color: "#AF52DE",
        view: "someday",
      },
      {
        name: "Anytime",
        icon: <List className="w-5 h-5" />,
        color: "#8E8E93",
        view: "anytime",
      },
    ];

    const handleViewSelect = (view) => {
      setSelectedView(view);
      setSelectedProject(null);
      setSelectedArea(null);
      closeQuickFind();
    };

    const handleProjectSelect = (projectId) => {
      setSelectedView("project");
      setSelectedProject(projectId);
      setSelectedArea(null);
      closeQuickFind();
    };

    const handleAreaSelect = (areaId) => {
      setSelectedView("area");
      setSelectedArea(areaId);
      setSelectedProject(null);
      closeQuickFind();
    };

    const handleTaskSelect = (task) => {
      setSelectedTask(task);
      setShowTaskDetail(true);
      closeQuickFind();
    };

    return (
      <div
        className={`fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-24 z-50 ${quickFindClosing ? "animate-fade-out" : !hasAnimated ? "animate-fade-in-up" : ""}`}
        onClick={closeQuickFind}
      >
        <div
          style={{
            backgroundColor: "white",
            borderRadius: "20px",
            width: "600px",
            maxHeight: "70vh",
          }}
          className={`shadow-2xl flex flex-col ${quickFindClosing ? "animate-bounce-out" : !hasAnimated ? "animate-bounce-in" : ""}`}
          onClick={(e) => e.stopPropagation()}
        >
          <div className="p-5">
            <div
              style={{ backgroundColor: "#F0F0F5", borderRadius: "16px" }}
              className="flex items-center gap-3 px-4 py-3.5"
            >
              <Search style={{ color: "#8E8E93" }} className="w-5 h-5" />
              <input
                type="text"
                value={localSearch}
                onChange={(e) => setLocalSearch(e.target.value)}
                placeholder="Quick Find"
                style={{ color: "#1C1C1E", backgroundColor: "transparent" }}
                className="flex-1 text-base outline-none placeholder-gray-400"
                autoFocus
              />
            </div>
          </div>

          <div className="flex-1 overflow-y-auto px-5 pb-5">
            {!localSearch ? (
              <>
                <div className="mb-4">
                  <h3
                    style={{ color: "#8E8E93" }}
                    className="text-xs font-semibold uppercase px-2 mb-2"
                  >
                    Recent
                  </h3>
                  <div className="space-y-1">
                    {recentViews.map((item) => {
                      const isActive = selectedView === item.view;
                      return (
                        <button
                          key={item.view}
                          onClick={() => handleViewSelect(item.view)}
                          style={{
                            backgroundColor: isActive
                              ? "#007AFF"
                              : "transparent",
                            borderRadius: "12px",
                          }}
                          className="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-[#F0F0F5] transition-smooth text-left"
                        >
                          <div
                            style={{ color: isActive ? "white" : item.color }}
                          >
                            {item.icon}
                          </div>
                          <span
                            style={{ color: isActive ? "white" : "#1C1C1E" }}
                            className="flex-1 text-base font-medium"
                          >
                            {item.name}
                          </span>
                          {isActive && (
                            <CheckCircle2
                              style={{ color: "white" }}
                              className="w-5 h-5"
                            />
                          )}
                        </button>
                      );
                    })}
                  </div>
                </div>
                <div className="text-center py-6">
                  <p style={{ color: "#8E8E93" }} className="text-sm">
                    Quickly switch lists, find to-dos,
                  </p>
                  <p style={{ color: "#8E8E93" }} className="text-sm">
                    search for tags...
                  </p>
                </div>
              </>
            ) : (
              <div className="space-y-4">
                {filteredTasks.length > 0 && (
                  <div>
                    <h3
                      style={{ color: "#8E8E93" }}
                      className="text-xs font-semibold uppercase px-2 mb-2"
                    >
                      Tasks
                    </h3>
                    <div className="space-y-1">
                      {filteredTasks.slice(0, 5).map((task) => (
                        <button
                          key={task.id}
                          onClick={() => handleTaskSelect(task)}
                          style={{
                            backgroundColor: "transparent",
                            borderRadius: "12px",
                          }}
                          className="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-[#F0F0F5] transition-smooth text-left"
                        >
                          {task.completed ? (
                            <CheckCircle2
                              style={{ color: "#007AFF" }}
                              className="w-5 h-5"
                            />
                          ) : (
                            <Circle
                              style={{ color: "#8E8E93" }}
                              className="w-5 h-5"
                            />
                          )}
                          <span
                            style={{ color: "#1C1C1E" }}
                            className="flex-1 text-sm"
                          >
                            {task.title}
                          </span>
                        </button>
                      ))}
                    </div>
                  </div>
                )}
                {filteredProjects.length > 0 && (
                  <div>
                    <h3
                      style={{ color: "#8E8E93" }}
                      className="text-xs font-semibold uppercase px-2 mb-2"
                    >
                      Projects
                    </h3>
                    <div className="space-y-1">
                      {filteredProjects.map((project) => (
                        <button
                          key={project.id}
                          onClick={() => handleProjectSelect(project.id)}
                          style={{
                            backgroundColor: "transparent",
                            borderRadius: "12px",
                          }}
                          className="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-[#F0F0F5] transition-smooth text-left"
                        >
                          <div
                            className="w-3 h-3 rounded-full"
                            style={{ backgroundColor: project.color }}
                          />
                          <span
                            style={{ color: "#1C1C1E" }}
                            className="flex-1 text-sm"
                          >
                            {project.name}
                          </span>
                        </button>
                      ))}
                    </div>
                  </div>
                )}
                {filteredAreas.length > 0 && (
                  <div>
                    <h3
                      style={{ color: "#8E8E93" }}
                      className="text-xs font-semibold uppercase px-2 mb-2"
                    >
                      Areas
                    </h3>
                    <div className="space-y-1">
                      {filteredAreas.map((area) => (
                        <button
                          key={area.id}
                          onClick={() => handleAreaSelect(area.id)}
                          style={{
                            backgroundColor: "transparent",
                            borderRadius: "12px",
                          }}
                          className="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-[#F0F0F5] transition-smooth text-left"
                        >
                          <Tag
                            style={{ color: "#FF2D55" }}
                            className="w-5 h-5"
                          />
                          <span
                            style={{ color: "#1C1C1E" }}
                            className="flex-1 text-sm"
                          >
                            {area.name}
                          </span>
                        </button>
                      ))}
                    </div>
                  </div>
                )}
                {filteredTasks.length === 0 &&
                  filteredProjects.length === 0 &&
                  filteredAreas.length === 0 && (
                    <div className="text-center py-8">
                      <p style={{ color: "#8E8E93" }} className="text-sm">
                        No results found
                      </p>
                    </div>
                  )}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  });

  const getTaskCount = (view) => {
    switch (view) {
      case "inbox":
        return tasks.filter(
          (t) => !t.completed && !t.when && !t.projectId && !t.areaId,
        ).length;
      case "today":
        const today = new Date().toDateString();
        return tasks.filter(
          (t) =>
            !t.completed &&
            (t.when === "today" ||
              (t.deadline && new Date(t.deadline).toDateString() === today)),
        ).length;
      case "upcoming":
        return tasks.filter((t) => !t.completed && t.when === "upcoming")
          .length;
      default:
        return 0;
    }
  };

  const EmojiPickerPanel = React.memo(() => {
    const [hasAnimated, setHasAnimated] = React.useState(false);
    const [localEmojiSearch, setLocalEmojiSearch] = React.useState("");

    React.useEffect(() => {
      if (showEmojiPicker && !hasAnimated) {
        setHasAnimated(true);
      }
    }, [showEmojiPicker, hasAnimated]);

    React.useEffect(() => {
      if (!showEmojiPicker) {
        setHasAnimated(false);
        setLocalEmojiSearch("");
      }
    }, [showEmojiPicker]);

    if (!showEmojiPicker) return null;

    const getFilteredEmojisLocal = () => {
      if (!localEmojiSearch.trim()) return emojiList;
      const search = localEmojiSearch.toLowerCase();
      return emojiList.filter(
        (item) =>
          item.name.toLowerCase().includes(search) ||
          item.keywords.some((keyword) => keyword.includes(search)),
      );
    };

    return (
      <div
        className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ${!hasAnimated ? "animate-fade-in-up" : ""}`}
        onClick={() => {
          setShowEmojiPicker(false);
        }}
      >
        <div
          style={{
            backgroundColor: "white",
            borderRadius: "20px",
            width: "400px",
            maxHeight: "500px",
          }}
          className={`shadow-2xl flex flex-col ${!hasAnimated ? "animate-bounce-in" : ""}`}
          onClick={(e) => e.stopPropagation()}
        >
          <div
            style={{ borderBottom: "1px solid #E5E5E5" }}
            className="px-6 py-5 flex items-center justify-between"
          >
            <h3 style={{ color: "#1C1C1E" }} className="text-xl font-semibold">
              Choose an Emoji
            </h3>
            <button
              onClick={() => {
                setShowEmojiPicker(false);
                setEmojiSearch("");
              }}
              style={{ color: "#8E8E93" }}
              className="hover:text-[#1C1C1E] transition-smooth"
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          <div className="px-6 py-4">
            <input
              type="text"
              value={localEmojiSearch}
              onChange={(e) => setLocalEmojiSearch(e.target.value)}
              placeholder="Search emojis... (e.g., rocket, work, goal)"
              style={{
                color: "#1C1C1E",
                borderRadius: "12px",
                border: "1px solid #E5E5E5",
                backgroundColor: "#FAFAFA",
              }}
              className="w-full px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
              autoFocus
            />
          </div>
          <div className="flex-1 overflow-y-auto px-6 pb-4">
            <div className="grid grid-cols-6 gap-2">
              {getFilteredEmojisLocal().map((item) => (
                <button
                  key={item.emoji}
                  onClick={() => {
                    if (selectedView === "project") {
                      updateProject(selectedProject, { emoji: item.emoji });
                    } else if (selectedView === "area") {
                      updateArea(selectedArea, { emoji: item.emoji });
                    }
                    setShowEmojiPicker(false);
                  }}
                  className="text-3xl hover:bg-gray-100 rounded-lg p-3 transition-smooth"
                  title={item.name}
                >
                  {item.emoji}
                </button>
              ))}
            </div>
            {getFilteredEmojisLocal().length === 0 && (
              <div className="text-center py-8">
                <p style={{ color: "#8E8E93" }} className="text-sm">
                  No emojis found
                </p>
              </div>
            )}
          </div>
          <div style={{ borderTop: "1px solid #E5E5E5" }} className="px-6 py-4">
            <button
              onClick={() => {
                if (selectedView === "project") {
                  updateProject(selectedProject, { emoji: null });
                } else if (selectedView === "area") {
                  updateArea(selectedArea, { emoji: null });
                }
                setShowEmojiPicker(false);
              }}
              style={{ color: "#FF3B30" }}
              className="text-sm hover:underline w-full text-center"
            >
              Remove Emoji
            </button>
          </div>
        </div>
      </div>
    );
  });

  const ProjectAreaSettingsPanel = React.memo(() => {
    const [localName, setLocalName] = React.useState("");
    const [localEmoji, setLocalEmoji] = React.useState("");
    const [showLocalEmojiPicker, setShowLocalEmojiPicker] =
      React.useState(false);
    const [hasAnimated, setHasAnimated] = React.useState(false);
    const [isClosing, setIsClosing] = React.useState(false);

    React.useEffect(() => {
      if (showSettingsPanel && !hasAnimated) {
        setHasAnimated(true);
      }
    }, [showSettingsPanel, hasAnimated]);

    React.useEffect(() => {
      if (!showSettingsPanel) {
        setHasAnimated(false);
        setIsClosing(false);
      }
    }, [showSettingsPanel]);

    React.useEffect(() => {
      if (showSettingsPanel && settingsPanelItem) {
        setLocalName(settingsPanelItem.name);
        setLocalEmoji(settingsPanelItem.emoji || "");
      }
    }, [showSettingsPanel, settingsPanelItem]);

    if (!showSettingsPanel || !settingsPanelItem) return null;

    const handleSave = () => {
      if (settingsPanelType === "project") {
        updateProject(settingsPanelItem.id, {
          name: localName,
          emoji: localEmoji || null,
        });
      } else if (settingsPanelType === "area") {
        updateArea(settingsPanelItem.id, {
          name: localName,
          emoji: localEmoji || null,
        });
      }
      setShowSettingsPanel(false);
      setSettingsPanelItem(null);
      setSettingsPanelType(null);
    };

    const handleDelete = () => {
      const itemType = settingsPanelType === "project" ? "project" : "area";
      const message =
        settingsPanelType === "project"
          ? `Delete "${settingsPanelItem.name}"?\n\nTasks in this project will be moved to Inbox.`
          : `Delete "${settingsPanelItem.name}"?\n\nProjects and tasks in this area will be unassigned.`;

      if (confirm(message)) {
        if (settingsPanelType === "project") {
          deleteProject(settingsPanelItem.id);
        } else if (settingsPanelType === "area") {
          deleteArea(settingsPanelItem.id);
        }
        setShowSettingsPanel(false);
        setSettingsPanelItem(null);
        setSettingsPanelType(null);
      }
    };

    const closePanel = () => {
      setIsClosing(true);
      setTimeout(() => {
        setShowSettingsPanel(false);
        setSettingsPanelItem(null);
        setSettingsPanelType(null);
      }, 200);
    };

    return (
      <div
        className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ${isClosing ? "animate-fade-out" : !hasAnimated ? "animate-fade-in-up" : ""}`}
        onClick={closePanel}
      >
        <div
          style={{
            backgroundColor: "white",
            borderRadius: "20px",
            width: "480px",
          }}
          className={`shadow-2xl flex flex-col ${isClosing ? "animate-bounce-out" : !hasAnimated ? "animate-bounce-in" : ""}`}
          onClick={(e) => e.stopPropagation()}
        >
          <div
            style={{ borderBottom: "1px solid #E5E5E5" }}
            className="px-6 py-5 flex items-center justify-between"
          >
            <h3 style={{ color: "#1C1C1E" }} className="text-xl font-semibold">
              {settingsPanelType === "project" ? "Project" : "Area"} Settings
            </h3>
            <button
              onClick={closePanel}
              style={{ color: "#8E8E93" }}
              className="hover:text-[#1C1C1E] transition-smooth "
            >
              <X className="w-5 h-5" />
            </button>
          </div>

          <div className="p-6 space-y-4">
            {/* Icon Section */}
            <div>
              <label
                style={{ color: "#8E8E93" }}
                className="text-xs font-semibold uppercase block mb-2"
              >
                Icon
              </label>
              <div className="flex items-center gap-3">
                <button
                  onClick={() => setShowLocalEmojiPicker(!showLocalEmojiPicker)}
                  style={{
                    backgroundColor: "#F0F0F5",
                    borderRadius: "12px",
                    border: "1px solid #E5E5E5",
                  }}
                  className="w-16 h-16 flex items-center justify-center text-3xl hover:bg-gray-200 transition-smooth"
                >
                  {localEmoji ||
                    (settingsPanelType === "project" ? "ðŸŽ¯" : "ðŸ ")}
                </button>
                {localEmoji && (
                  <button
                    onClick={() => setLocalEmoji("")}
                    style={{ color: "#FF3B30" }}
                    className="text-sm hover:underline"
                  >
                    Remove Icon
                  </button>
                )}
              </div>

              {/* Inline Emoji Picker */}
              {showLocalEmojiPicker && (
                <div
                  style={{
                    backgroundColor: "#FAFAFA",
                    borderRadius: "12px",
                    border: "1px solid #E5E5E5",
                  }}
                  className="mt-3 p-3 max-h-48 overflow-y-auto"
                >
                  <div className="grid grid-cols-8 gap-2">
                    {emojiList.map((item) => (
                      <button
                        key={item.emoji}
                        onClick={() => {
                          setLocalEmoji(item.emoji);
                          setShowLocalEmojiPicker(false);
                        }}
                        className="text-2xl hover:bg-gray-200 rounded-lg p-2 transition-smooth"
                        title={item.name}
                      >
                        {item.emoji}
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Name Section */}
            <div>
              <label
                style={{ color: "#8E8E93" }}
                className="text-xs font-semibold uppercase block mb-2"
              >
                Name
              </label>
              <input
                type="text"
                value={localName}
                onChange={(e) => setLocalName(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === "Enter") handleSave();
                }}
                placeholder={
                  settingsPanelType === "project" ? "Project name" : "Area name"
                }
                style={{
                  color: "#1C1C1E",
                  borderRadius: "12px",
                  border: "1px solid #E5E5E5",
                  backgroundColor: "#FAFAFA",
                }}
                className="w-full px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF] transition-smooth"
                autoFocus
              />
            </div>

            {/* Task Count Info */}
            <div
              style={{
                backgroundColor: "#F0F0F5",
                borderRadius: "12px",
              }}
              className="p-3"
            >
              <p style={{ color: "#8E8E93" }} className="text-xs">
                {settingsPanelType === "project" ? (
                  <>
                    {
                      tasks.filter(
                        (t) =>
                          t.projectId === settingsPanelItem.id && !t.completed,
                      ).length
                    }{" "}
                    active task(s)
                  </>
                ) : (
                  <>
                    {
                      projects.filter((p) => p.areaId === settingsPanelItem.id)
                        .length
                    }{" "}
                    project(s) â€¢{" "}
                    {
                      tasks.filter(
                        (t) =>
                          t.areaId === settingsPanelItem.id && !t.completed,
                      ).length
                    }{" "}
                    active task(s)
                  </>
                )}
              </p>
            </div>
          </div>

          {/* Actions */}
          <div
            style={{ borderTop: "1px solid #E5E5E5" }}
            className="px-6 py-4 flex items-center justify-between"
          >
            <button
              onClick={handleDelete}
              style={{
                color: "#FF3B30",
                borderRadius: "12px",
                border: "1px solid #FF3B30",
              }}
              className="px-4 py-2 text-sm font-medium hover:bg-red-50 transition-smooth "
            >
              Delete {settingsPanelType === "project" ? "Project" : "Area"}
            </button>
            <button
              onClick={handleSave}
              style={{
                backgroundColor: "#007AFF",
                borderRadius: "12px",
              }}
              className="px-6 py-2 text-white text-sm font-medium hover:bg-[#0051D5] transition-smooth "
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    );
  });

  const themes = [
    { id: "none", name: "None", image: "", isDark: false },
    {
      id: "dark",
      name: "Dark Mode",
      image: "",
      isDark: true,
    },
    {
      id: "gradient-blue",
      name: "Blue Wave",
      image: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
      isDark: false,
    },
    {
      id: "gradient-sunset",
      name: "Sunset",
      image: "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
      isDark: false,
    },
    {
      id: "gradient-ocean",
      name: "Ocean",
      image: "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
      isDark: false,
    },
    {
      id: "gradient-forest",
      name: "Forest",
      image: "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
      isDark: false,
    },
    {
      id: "gradient-purple",
      name: "Purple Dream",
      image: "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
      isDark: false,
    },
    {
      id: "gradient-fire",
      name: "Fire",
      image: "linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%)",
      isDark: false,
    },
    {
      id: "gradient-mint",
      name: "Mint",
      image: "linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)",
      isDark: false,
    },
  ];

  const AppSettingsPanel = React.memo(() => {
    const [hasAnimated, setHasAnimated] = React.useState(false);
    const [localTheme, setLocalTheme] = React.useState(selectedTheme);
    const [localDefaultView, setLocalDefaultView] = React.useState(defaultView);
    const [localCompletionSound, setLocalCompletionSound] =
      React.useState(completionSound);
    const [localShowConfirmDialogs, setLocalShowConfirmDialogs] =
      React.useState(showConfirmDialogs);
    const [localShowTaskCounts, setLocalShowTaskCounts] =
      React.useState(showTaskCounts);
    const [localTimeFormat, setLocalTimeFormat] = React.useState(timeFormat);

    React.useEffect(() => {
      if (showAppSettings && !hasAnimated) {
        setHasAnimated(true);
        // Reset local state when panel opens
        setLocalTheme(selectedTheme);
        setLocalDefaultView(defaultView);
        setLocalCompletionSound(completionSound);
        setLocalShowConfirmDialogs(showConfirmDialogs);
        setLocalShowTaskCounts(showTaskCounts);
        setLocalTimeFormat(timeFormat);
      }
    }, [showAppSettings, hasAnimated]);

    React.useEffect(() => {
      if (!showAppSettings) {
        setHasAnimated(false);
      }
    }, [showAppSettings]);

    const closePanel = () => {
      // Apply all settings when closing
      setSelectedTheme(localTheme);
      setDefaultView(localDefaultView);
      setCompletionSound(localCompletionSound);
      setShowConfirmDialogs(localShowConfirmDialogs);
      setShowTaskCounts(localShowTaskCounts);
      setTimeFormat(localTimeFormat);

      setAppSettingsClosing(true);
      setTimeout(() => {
        setShowAppSettings(false);
        setAppSettingsClosing(false);
      }, 200);
    };

    if (!showAppSettings) return null;

    return (
      <div
        className={`fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center pt-24 z-50 ${appSettingsClosing ? "animate-fade-out" : !hasAnimated ? "animate-fade-in-up" : ""}`}
        onClick={closePanel}
      >
        <div
          onClick={(e) => e.stopPropagation()}
          style={{
            backgroundColor: isDarkMode ? "#252525" : "white",
            borderRadius: "20px",
            width: "600px",
            maxHeight: "70vh",
          }}
          className={`shadow-2xl flex flex-col ${appSettingsClosing ? "animate-bounce-out" : !hasAnimated ? "animate-bounce-in" : ""}`}
        >
          <div
            style={{
              borderBottom: isDarkMode
                ? "1px solid #3a3a3a"
                : "1px solid #E5E5E5",
              background: isDarkMode
                ? "linear-gradient(to bottom, #252525, #252525)"
                : "linear-gradient(to bottom, #FAFAFA, #FFFFFF)",
              borderTopLeftRadius: "20px",
              borderTopRightRadius: "20px",
            }}
            className="px-6 py-5 flex items-center justify-between"
          >
            <h3
              style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
              className="text-lg font-semibold"
            >
              Settings
            </h3>
            <button
              onClick={closePanel}
              style={{ color: "#8E8E93" }}
              className="hover:text-[#1C1C1E] transition-smooth "
            >
              <X className="w-5 h-5" />
            </button>
          </div>

          <div className="flex-1 overflow-y-auto p-6 space-y-6">
            {/* General Settings Section */}
            <div>
              <h4
                style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                className="text-base font-semibold mb-3"
              >
                General
              </h4>

              {/* Default View */}
              <div className="mb-4">
                <label
                  style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                  className="text-sm font-medium block mb-2"
                >
                  Default view on startup
                </label>
                <select
                  value={localDefaultView}
                  onChange={(e) => setLocalDefaultView(e.target.value)}
                  style={{
                    color: isDarkMode ? "#ffffff" : "#1C1C1E",
                    borderRadius: "12px",
                    border: isDarkMode
                      ? "1px solid #3a3a3a"
                      : "1px solid #E5E5E5",
                    backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                  }}
                  className="w-full px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
                >
                  <option value="inbox">Inbox</option>
                  <option value="today">Today</option>
                  <option value="upcoming">Upcoming</option>
                  <option value="anytime">Anytime</option>
                  <option value="someday">Someday</option>
                  <option value="logbook">Logbook</option>
                </select>
              </div>

              {/* Completion Sound */}
              <div className="flex items-center justify-between mb-4">
                <div>
                  <label
                    style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                    className="text-sm font-medium block"
                  >
                    Task completion sound
                  </label>
                  <p style={{ color: "#8E8E93" }} className="text-xs mt-0.5">
                    Play a sound when completing tasks
                  </p>
                </div>
                <button
                  onClick={() => setLocalCompletionSound(!localCompletionSound)}
                  style={{
                    width: "44px",
                    height: "26px",
                    borderRadius: "13px",
                    backgroundColor: localCompletionSound
                      ? "#34C759"
                      : "#E5E5E5",
                    position: "relative",
                    transition: "background-color 0.2s",
                  }}
                  className="flex-shrink-0"
                >
                  <div
                    style={{
                      width: "22px",
                      height: "22px",
                      borderRadius: "50%",
                      backgroundColor: "white",
                      position: "absolute",
                      top: "2px",
                      left: localCompletionSound ? "20px" : "2px",
                      transition: "left 0.2s",
                      boxShadow: "0 2px 4px rgba(0, 0, 0, 0.2)",
                    }}
                  />
                </button>
              </div>

              {/* Confirmation Dialogs */}
              <div className="flex items-center justify-between">
                <div>
                  <label
                    style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                    className="text-sm font-medium block"
                  >
                    Confirmation dialogs
                  </label>
                  <p style={{ color: "#8E8E93" }} className="text-xs mt-0.5">
                    Ask before deleting tasks and items
                  </p>
                </div>
                <button
                  onClick={() =>
                    setLocalShowConfirmDialogs(!localShowConfirmDialogs)
                  }
                  style={{
                    width: "44px",
                    height: "26px",
                    borderRadius: "13px",
                    backgroundColor: localShowConfirmDialogs
                      ? "#34C759"
                      : "#E5E5E5",
                    position: "relative",
                    transition: "background-color 0.2s",
                  }}
                  className="flex-shrink-0"
                >
                  <div
                    style={{
                      width: "22px",
                      height: "22px",
                      borderRadius: "50%",
                      backgroundColor: "white",
                      position: "absolute",
                      top: "2px",
                      left: localShowConfirmDialogs ? "20px" : "2px",
                      transition: "left 0.2s",
                      boxShadow: "0 2px 4px rgba(0, 0, 0, 0.2)",
                    }}
                  />
                </button>
              </div>
            </div>

            {/* Theme Section */}
            <div>
              <h4
                style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                className="text-base font-semibold mb-3"
              >
                Theme
              </h4>
              <p style={{ color: "#8E8E93" }} className="text-sm mb-4">
                Choose a background theme for your workspace
              </p>
              <div
                style={{
                  display: "grid",
                  gridTemplateColumns: "repeat(4, 1fr)",
                  gap: "12px",
                }}
              >
                {themes.map((theme) => (
                  <button
                    key={theme.id}
                    onClick={() => setLocalTheme(theme.id)}
                    style={{
                      border:
                        localTheme === theme.id
                          ? "2px solid #007AFF"
                          : isDarkMode
                            ? "1px solid #3a3a3a"
                            : "1px solid #E5E5E5",
                      borderRadius: "12px",
                      padding: "8px",
                      background: isDarkMode ? "#2a2a2a" : "white",
                      cursor: "pointer",
                      position: "relative",
                    }}
                    className="hover:shadow-md transition-smooth"
                  >
                    <div
                      style={{
                        width: "100%",
                        height: "80px",
                        borderRadius: "8px",
                        background:
                          theme.id === "dark"
                            ? "#1a1a1a"
                            : theme.image || "#F7F7F7",
                        marginBottom: "8px",
                      }}
                    />
                    <div
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        fontSize: "12px",
                        fontWeight: "500",
                      }}
                    >
                      {theme.name}
                    </div>
                    {localTheme === theme.id && (
                      <div
                        style={{
                          position: "absolute",
                          top: "12px",
                          right: "12px",
                          backgroundColor: "#007AFF",
                          borderRadius: "50%",
                          width: "20px",
                          height: "20px",
                          display: "flex",
                          alignItems: "center",
                          justifyContent: "center",
                        }}
                      >
                        <CheckCircle2
                          style={{ color: "white" }}
                          className="w-3 h-3"
                        />
                      </div>
                    )}
                  </button>
                ))}
              </div>
            </div>

            {/* Appearance Settings Section */}
            <div>
              <h4
                style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                className="text-base font-semibold mb-3"
              >
                Appearance
              </h4>

              {/* Show Task Counts */}
              <div className="flex items-center justify-between mb-4">
                <div>
                  <label
                    style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                    className="text-sm font-medium block"
                  >
                    Show task counts
                  </label>
                  <p style={{ color: "#8E8E93" }} className="text-xs mt-0.5">
                    Display task counts on sidebar items
                  </p>
                </div>
                <button
                  onClick={() => setLocalShowTaskCounts(!localShowTaskCounts)}
                  style={{
                    width: "44px",
                    height: "26px",
                    borderRadius: "13px",
                    backgroundColor: localShowTaskCounts
                      ? "#34C759"
                      : "#E5E5E5",
                    position: "relative",
                    transition: "background-color 0.2s",
                  }}
                  className="flex-shrink-0"
                >
                  <div
                    style={{
                      width: "22px",
                      height: "22px",
                      borderRadius: "50%",
                      backgroundColor: "white",
                      position: "absolute",
                      top: "2px",
                      left: localShowTaskCounts ? "20px" : "2px",
                      transition: "left 0.2s",
                      boxShadow: "0 2px 4px rgba(0, 0, 0, 0.2)",
                    }}
                  />
                </button>
              </div>

              {/* Time Format */}
              <div>
                <label
                  style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                  className="text-sm font-medium block mb-2"
                >
                  Time format
                </label>
                <select
                  value={localTimeFormat}
                  onChange={(e) => setLocalTimeFormat(e.target.value)}
                  style={{
                    color: isDarkMode ? "#ffffff" : "#1C1C1E",
                    borderRadius: "12px",
                    border: isDarkMode
                      ? "1px solid #3a3a3a"
                      : "1px solid #E5E5E5",
                    backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                  }}
                  className="w-full px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
                >
                  <option value="12">12-hour (2:30 PM)</option>
                  <option value="24">24-hour (14:30)</option>
                </select>
              </div>
            </div>

            {/* Data Management Section */}
            <div>
              <h4
                style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                className="text-base font-semibold mb-3"
              >
                Data Management
              </h4>

              <div className="space-y-2">
                <button
                  onClick={() => {
                    const data = {
                      tasks,
                      projects,
                      areas,
                      tags,
                      version: "1.0.0",
                      exportDate: new Date().toISOString(),
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                      type: "application/json",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `stuff-app-backup-${new Date().toISOString().split("T")[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                  }}
                  style={{
                    color: "#007AFF",
                    backgroundColor: "#007AFF10",
                    borderRadius: "12px",
                    border: "1px solid #007AFF30",
                  }}
                  className="w-full px-4 py-3 text-sm font-medium hover:bg-[#007AFF20] transition-smooth"
                >
                  Export All Data
                </button>

                <button
                  onClick={() => {
                    const input = document.createElement("input");
                    input.type = "file";
                    input.accept = "application/json";
                    input.onchange = (e) => {
                      const file = e.target.files[0];
                      if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                          try {
                            const data = JSON.parse(event.target.result);
                            if (data.tasks) setTasks(data.tasks);
                            if (data.projects) setProjects(data.projects);
                            if (data.areas) setAreas(data.areas);
                            if (data.tags) setTags(data.tags);
                            alert("Data imported successfully!");
                          } catch (error) {
                            alert(
                              "Error importing data. Please check the file format.",
                            );
                          }
                        };
                        reader.readAsText(file);
                      }
                    };
                    input.click();
                  }}
                  style={{
                    color: "#007AFF",
                    backgroundColor: "#007AFF10",
                    borderRadius: "12px",
                    border: "1px solid #007AFF30",
                  }}
                  className="w-full px-4 py-3 text-sm font-medium hover:bg-[#007AFF20] transition-smooth"
                >
                  Import Data from File
                </button>

                <button
                  onClick={() => {
                    if (
                      (showConfirmDialogs &&
                        confirm(
                          "Clear all completed tasks from Logbook? This cannot be undone.",
                        )) ||
                      !showConfirmDialogs
                    ) {
                      setTasks(tasks.filter((t) => !t.completed));
                    }
                  }}
                  style={{
                    color: "#FF9500",
                    backgroundColor: "#FF950010",
                    borderRadius: "12px",
                    border: "1px solid #FF950030",
                  }}
                  className="w-full px-4 py-3 text-sm font-medium hover:bg-[#FF950020] transition-smooth"
                >
                  Clear Completed Tasks
                </button>

                <button
                  onClick={() => {
                    if (
                      (showConfirmDialogs &&
                        confirm(
                          "Reset ALL data? This will delete everything and cannot be undone!",
                        )) ||
                      !showConfirmDialogs
                    ) {
                      if (
                        (showConfirmDialogs &&
                          confirm(
                            "Are you absolutely sure? This is your last chance!",
                          )) ||
                        !showConfirmDialogs
                      ) {
                        setTasks([]);
                        setProjects([]);
                        setAreas([]);
                        setTags([]);
                        setSelectedView("inbox");
                        setSelectedProject(null);
                        setSelectedArea(null);
                        localStorage.clear();
                        alert("All data has been reset.");
                      }
                    }
                  }}
                  style={{
                    color: "#FF3B30",
                    backgroundColor: "#FF3B3010",
                    borderRadius: "12px",
                    border: "1px solid #FF3B3030",
                  }}
                  className="w-full px-4 py-3 text-sm font-medium hover:bg-[#FF3B3020] transition-smooth"
                >
                  Reset All Data
                </button>
              </div>
            </div>

            {/* Keyboard Shortcuts Section */}
            <div>
              <h4
                style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                className="text-base font-semibold mb-3"
              >
                Keyboard Shortcuts
              </h4>
              <div
                style={{
                  backgroundColor: isDarkMode ? "#2a2a2a" : "#F7F7F7",
                  borderRadius: "12px",
                  padding: "16px",
                }}
              >
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Quick Find</span>
                    <kbd
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                        padding: "4px 8px",
                        borderRadius: "6px",
                        border: isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                        fontFamily: "monospace",
                      }}
                    >
                      âŒ˜K
                    </kbd>
                  </div>
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>New Task</span>
                    <kbd
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                        padding: "4px 8px",
                        borderRadius: "6px",
                        border: isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                        fontFamily: "monospace",
                      }}
                    >
                      Shift+N
                    </kbd>
                  </div>
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Close Panel</span>
                    <kbd
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                        padding: "4px 8px",
                        borderRadius: "6px",
                        border: isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                        fontFamily: "monospace",
                      }}
                    >
                      Esc
                    </kbd>
                  </div>
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Switch to Inbox</span>
                    <kbd
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                        padding: "4px 8px",
                        borderRadius: "6px",
                        border: isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                        fontFamily: "monospace",
                      }}
                    >
                      1
                    </kbd>
                  </div>
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Switch to Today</span>
                    <kbd
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                        padding: "4px 8px",
                        borderRadius: "6px",
                        border: isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                        fontFamily: "monospace",
                      }}
                    >
                      2
                    </kbd>
                  </div>
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Switch to Upcoming</span>
                    <kbd
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                        padding: "4px 8px",
                        borderRadius: "6px",
                        border: isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                        fontFamily: "monospace",
                      }}
                    >
                      3
                    </kbd>
                  </div>
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Switch to Anytime</span>
                    <kbd
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                        padding: "4px 8px",
                        borderRadius: "6px",
                        border: isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                        fontFamily: "monospace",
                      }}
                    >
                      4
                    </kbd>
                  </div>
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Switch to Someday</span>
                    <kbd
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                        padding: "4px 8px",
                        borderRadius: "6px",
                        border: isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                        fontFamily: "monospace",
                      }}
                    >
                      5
                    </kbd>
                  </div>
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Switch to Logbook</span>
                    <kbd
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        backgroundColor: isDarkMode ? "#1a1a1a" : "white",
                        padding: "4px 8px",
                        borderRadius: "6px",
                        border: isDarkMode
                          ? "1px solid #3a3a3a"
                          : "1px solid #E5E5E5",
                        fontFamily: "monospace",
                      }}
                    >
                      6
                    </kbd>
                  </div>
                </div>
              </div>
            </div>

            {/* About Section */}
            <div>
              <h4
                style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                className="text-base font-semibold mb-3"
              >
                About
              </h4>
              <div
                style={{
                  backgroundColor: isDarkMode ? "#2a2a2a" : "#F7F7F7",
                  borderRadius: "12px",
                  padding: "16px",
                }}
              >
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Version</span>
                    <span
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        fontWeight: "500",
                      }}
                    >
                      1.0.0
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span style={{ color: "#8E8E93" }}>Build</span>
                    <span
                      style={{
                        color: isDarkMode ? "#ffffff" : "#1C1C1E",
                        fontWeight: "500",
                      }}
                    >
                      2025.01
                    </span>
                  </div>
                  <div
                    className="pt-2"
                    style={{
                      borderTop: isDarkMode
                        ? "1px solid #3a3a3a"
                        : "1px solid #E5E5E5",
                    }}
                  >
                    <p style={{ color: "#8E8E93", fontSize: "12px" }}>
                      Built with React, Vite, and Tailwind CSS
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  });

  const getViewIcon = () => {
    switch (selectedView) {
      case "inbox":
        return { icon: <Inbox className="w-5 h-5" />, color: "#007AFF" };
      case "today":
        return { icon: <Star className="w-5 h-5" />, color: "#FFC107" };
      case "upcoming":
        return { icon: <Calendar className="w-5 h-5" />, color: "#FF3B30" };
      case "review":
        return { icon: <BarChart3 className="w-5 h-5" />, color: "#8E8E93" };
      case "someday":
        return { icon: <ChevronRight className="w-5 h-5" />, color: "#AF52DE" };
      case "logbook":
        return { icon: <CheckCircle2 className="w-5 h-5" />, color: "#34C759" };
      case "project":
        return {
          icon: null,
          color:
            projects.find((p) => p.id === selectedProject)?.color || "#007AFF",
          emoji: projects.find((p) => p.id === selectedProject)?.emoji || "ðŸŽ¯",
        };
      case "area":
        return {
          icon: null,
          color: "#FF2D55",
          emoji: areas.find((a) => a.id === selectedArea)?.emoji || "ðŸ ",
        };
      default:
        return { icon: null, color: "#007AFF" };
    }
  };

  const getThemeBackground = () => {
    const theme = themes.find((t) => t.id === selectedTheme);
    if (!theme || theme.id === "none") return "white";
    if (theme.id === "dark") return "#252525";
    return theme.image;
  };

  const isDarkMode = selectedTheme === "dark";

  return (
    <div
      className="flex h-screen font-sans"
      style={{
        background: getThemeBackground(),
        position: "relative",
      }}
    >
      {selectedTheme !== "none" && selectedTheme !== "dark" && (
        <div
          style={{
            position: "absolute",
            inset: 0,
            backgroundColor: "rgba(255, 255, 255, 0.85)",
            zIndex: 1,
            pointerEvents: "none",
          }}
        />
      )}
      {/* Overlay blocker for header - prevents white overlay from showing through header */}
      {selectedTheme !== "none" && selectedTheme !== "dark" && (
        <div
          style={{
            position: "fixed",
            top: 0,
            left: "256px",
            right: 0,
            height: "73px",
            backgroundColor: "transparent",
            zIndex: 19,
            pointerEvents: "none",
          }}
        />
      )}
      <style>{`
        @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.95); } 50% { transform: scale(1.01); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes bounceOut { 0% { opacity: 1; transform: scale(1); } 50% { transform: scale(1.01); } 100% { opacity: 0; transform: scale(0.95); } }
        @keyframes slideInRight { 0% { transform: translateX(100%); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { 0% { transform: translateX(-100%); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
        @keyframes fadeInUp {
          0% { opacity: 0; transform: translateY(30px) scale(0.92); }
          50% { opacity: 1; transform: translateY(-10px) scale(1.04); }
          70% { transform: translateY(3px) scale(0.98); }
          100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes scaleIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes checkmarkPop {
          0% { transform: scale(0.8); opacity: 0; }
          50% { transform: scale(1.2); }
          100% { transform: scale(1); opacity: 1; }
        }
        @keyframes taskComplete {
          0% { opacity: 1; transform: translateX(0); }
          100% { opacity: 0; transform: translateX(20px); }
        }
        .animate-bounce-in { animation: bounceIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .animate-bounce-out { animation: bounceOut 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-slide-in-right { animation: slideInRight 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .animate-slide-in-left { animation: slideInLeft 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .animate-fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .animate-fade-out { animation: fadeOut 0.25s ease-out forwards; }
        .animate-scale-in { animation: scaleIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .transition-smooth { transition: all 0.15s ease-out; }
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        input, textarea, select { font-family: inherit; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #AEAEB2; }
      `}</style>

      <div
        style={{
          backgroundColor: "transparent",
          borderRight: "none",
          padding: "12px",
          paddingRight: "0",
          position: "relative",
          zIndex: 20,
        }}
        className="w-64 flex flex-col animate-slide-in-left"
      >
        <div
          style={{
            backgroundColor: isDarkMode ? "#252525" : "#F7F7F7",
            borderRadius: "20px",
            boxShadow: isDarkMode
              ? "0 4px 24px rgba(0, 0, 0, 0.4)"
              : "0 4px 24px rgba(0, 0, 0, 0.08)",
            border: isDarkMode ? "1px solid #2a2a2a" : "1px solid #E5E5E5",
            height: "100%",
          }}
          className="flex flex-col"
        >
          <div
            style={{
              borderBottom: isDarkMode
                ? "1px solid #2a2a2a"
                : "1px solid #E5E5E5",
            }}
            className="p-4 flex items-center justify-between"
          >
            <h1
              style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
              className="text-xl font-semibold"
            >
              Stuff
            </h1>
            <div className="flex items-center gap-3">
              <button
                onClick={() => setShowProjectPanel(true)}
                style={{ color: isDarkMode ? "#8E8E93" : "#8E8E93" }}
                className={
                  isDarkMode ? "hover:text-[#ffffff]" : "hover:text-[#1C1C1E]"
                }
                title="Manage Projects"
              >
                <List className="w-5 h-5" />
              </button>
              <button
                onClick={() => setShowTagPanel(true)}
                style={{ color: isDarkMode ? "#8E8E93" : "#8E8E93" }}
                className={
                  isDarkMode ? "hover:text-[#ffffff]" : "hover:text-[#1C1C1E]"
                }
                title="Manage Tags"
              >
                <Tag className="w-5 h-5" />
              </button>
              <button
                onClick={() => setShowQuickFind(true)}
                style={{ color: isDarkMode ? "#8E8E93" : "#8E8E93" }}
                className={
                  isDarkMode ? "hover:text-[#ffffff]" : "hover:text-[#1C1C1E]"
                }
                title="Quick Find (âŒ˜K)"
              >
                <Search className="w-5 h-5" />
              </button>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto">
            <div className="p-3 space-y-2">
              <button
                onClick={() => {
                  setSelectedView("inbox");
                  setSelectedProject(null);
                  setSelectedArea(null);
                }}
                style={{
                  backgroundColor:
                    selectedView === "inbox"
                      ? "#007AFF"
                      : isDarkMode
                        ? "#2a2a2a"
                        : "white",
                  color:
                    selectedView === "inbox"
                      ? "white"
                      : isDarkMode
                        ? "#ffffff"
                        : "#1C1C1E",
                  borderRadius: "18px",
                  border:
                    selectedView === "inbox"
                      ? "none"
                      : isDarkMode
                        ? "1px solid #3a3a3a"
                        : "1px solid #E5E5E5",
                  boxShadow:
                    selectedView === "inbox"
                      ? "0 2px 8px rgba(0, 122, 255, 0.3)"
                      : isDarkMode
                        ? "0 2px 4px rgba(0, 0, 0, 0.2)"
                        : "0 2px 4px rgba(0, 0, 0, 0.04)",
                }}
                className="w-full flex items-center gap-3 px-4 py-3 text-sm transition-smooth hover:shadow-md"
              >
                <Inbox
                  style={{
                    color: selectedView === "inbox" ? "white" : "#007AFF",
                  }}
                  className="w-5 h-5"
                />
                <span className="flex-1 text-left font-medium">Inbox</span>
                {showTaskCounts && getTaskCount("inbox") > 0 && (
                  <span
                    style={{
                      backgroundColor:
                        selectedView === "inbox"
                          ? "rgba(255,255,255,0.3)"
                          : isDarkMode
                            ? "#3a3a3a"
                            : "#F0F0F5",
                      color:
                        selectedView === "inbox"
                          ? "white"
                          : isDarkMode
                            ? "#ffffff"
                            : "#1C1C1E",
                      borderRadius: "10px",
                    }}
                    className="text-xs px-2 py-0.5 font-semibold"
                  >
                    {getTaskCount("inbox")}
                  </span>
                )}
              </button>
              <button
                onClick={() => {
                  setSelectedView("today");
                  setSelectedProject(null);
                  setSelectedArea(null);
                }}
                style={{
                  backgroundColor:
                    selectedView === "today"
                      ? "#007AFF"
                      : isDarkMode
                        ? "#2a2a2a"
                        : "white",
                  color:
                    selectedView === "today"
                      ? "white"
                      : isDarkMode
                        ? "#ffffff"
                        : "#1C1C1E",
                  borderRadius: "18px",
                  border:
                    selectedView === "today"
                      ? "none"
                      : isDarkMode
                        ? "1px solid #3a3a3a"
                        : "1px solid #E5E5E5",
                  boxShadow:
                    selectedView === "today"
                      ? "0 2px 8px rgba(0, 122, 255, 0.3)"
                      : isDarkMode
                        ? "0 2px 4px rgba(0, 0, 0, 0.2)"
                        : "0 2px 4px rgba(0, 0, 0, 0.04)",
                }}
                className="w-full flex items-center gap-3 px-4 py-3 text-sm transition-smooth hover:shadow-md"
              >
                <Star
                  style={{
                    color: selectedView === "today" ? "white" : "#FFC107",
                  }}
                  className="w-5 h-5"
                />
                <span className="flex-1 text-left font-medium">Today</span>
                {showTaskCounts && getTaskCount("today") > 0 && (
                  <span
                    style={{
                      backgroundColor:
                        selectedView === "today"
                          ? "rgba(255,255,255,0.3)"
                          : isDarkMode
                            ? "#3a3a3a"
                            : "#F0F0F5",
                      color:
                        selectedView === "today"
                          ? "white"
                          : isDarkMode
                            ? "#ffffff"
                            : "#1C1C1E",
                      borderRadius: "10px",
                    }}
                    className="text-xs px-2 py-0.5 font-semibold"
                  >
                    {getTaskCount("today")}
                  </span>
                )}
              </button>
              <button
                onClick={() => {
                  setSelectedView("upcoming");
                  setSelectedProject(null);
                  setSelectedArea(null);
                }}
                style={{
                  backgroundColor:
                    selectedView === "upcoming"
                      ? "#007AFF"
                      : isDarkMode
                        ? "#2a2a2a"
                        : "white",
                  color:
                    selectedView === "upcoming"
                      ? "white"
                      : isDarkMode
                        ? "#ffffff"
                        : "#1C1C1E",
                  borderRadius: "18px",
                  border:
                    selectedView === "upcoming"
                      ? "none"
                      : isDarkMode
                        ? "1px solid #3a3a3a"
                        : "1px solid #E5E5E5",
                  boxShadow:
                    selectedView === "upcoming"
                      ? "0 2px 8px rgba(0, 122, 255, 0.3)"
                      : isDarkMode
                        ? "0 2px 4px rgba(0, 0, 0, 0.2)"
                        : "0 2px 4px rgba(0, 0, 0, 0.04)",
                }}
                className="w-full flex items-center gap-3 px-4 py-3 text-sm transition-smooth hover:shadow-md"
              >
                <Calendar
                  style={{
                    color: selectedView === "upcoming" ? "white" : "#FF3B30",
                  }}
                  className="w-5 h-5"
                />
                <span className="flex-1 text-left font-medium">Upcoming</span>
                {showTaskCounts && getTaskCount("upcoming") > 0 && (
                  <span
                    style={{
                      backgroundColor:
                        selectedView === "upcoming"
                          ? "rgba(255,255,255,0.3)"
                          : isDarkMode
                            ? "#3a3a3a"
                            : "#F0F0F5",
                      color:
                        selectedView === "upcoming"
                          ? "white"
                          : isDarkMode
                            ? "#ffffff"
                            : "#1C1C1E",
                      borderRadius: "10px",
                    }}
                    className="text-xs px-2 py-0.5 font-semibold"
                  >
                    {getTaskCount("upcoming")}
                  </span>
                )}
              </button>
              <button
                onClick={() => {
                  setSelectedView("review");
                  setSelectedProject(null);
                  setSelectedArea(null);
                }}
                style={{
                  backgroundColor:
                    selectedView === "review"
                      ? "#007AFF"
                      : isDarkMode
                        ? "#2a2a2a"
                        : "white",
                  color:
                    selectedView === "review"
                      ? "white"
                      : isDarkMode
                        ? "#ffffff"
                        : "#1C1C1E",
                  borderRadius: "18px",
                  border:
                    selectedView === "review"
                      ? "none"
                      : isDarkMode
                        ? "1px solid #3a3a3a"
                        : "1px solid #E5E5E5",
                  boxShadow:
                    selectedView === "review"
                      ? "0 2px 8px rgba(0, 122, 255, 0.3)"
                      : isDarkMode
                        ? "0 2px 4px rgba(0, 0, 0, 0.2)"
                        : "0 2px 4px rgba(0, 0, 0, 0.04)",
                }}
                className="w-full flex items-center gap-3 px-4 py-3 text-sm transition-smooth hover:shadow-md"
              >
                <BarChart3
                  style={{
                    color: selectedView === "review" ? "white" : "#8E8E93",
                  }}
                  className="w-5 h-5"
                />
                <span className="flex-1 text-left font-medium">Review</span>
              </button>
              <button
                onClick={() => {
                  setSelectedView("someday");
                  setSelectedProject(null);
                  setSelectedArea(null);
                }}
                style={{
                  backgroundColor:
                    selectedView === "someday"
                      ? "#007AFF"
                      : isDarkMode
                        ? "#2a2a2a"
                        : "white",
                  color:
                    selectedView === "someday"
                      ? "white"
                      : isDarkMode
                        ? "#ffffff"
                        : "#1C1C1E",
                  borderRadius: "18px",
                  border:
                    selectedView === "someday"
                      ? "none"
                      : isDarkMode
                        ? "1px solid #3a3a3a"
                        : "1px solid #E5E5E5",
                  boxShadow:
                    selectedView === "someday"
                      ? "0 2px 8px rgba(0, 122, 255, 0.3)"
                      : isDarkMode
                        ? "0 2px 4px rgba(0, 0, 0, 0.2)"
                        : "0 2px 4px rgba(0, 0, 0, 0.04)",
                }}
                className="w-full flex items-center gap-3 px-4 py-3 text-sm transition-smooth hover:shadow-md"
              >
                <ChevronRight
                  style={{
                    color: selectedView === "someday" ? "white" : "#AF52DE",
                  }}
                  className="w-5 h-5"
                />
                <span className="flex-1 text-left font-medium">Someday</span>
              </button>
              <button
                onClick={() => {
                  setSelectedView("logbook");
                  setSelectedProject(null);
                  setSelectedArea(null);
                }}
                style={{
                  backgroundColor:
                    selectedView === "logbook"
                      ? "#007AFF"
                      : isDarkMode
                        ? "#2a2a2a"
                        : "white",
                  color:
                    selectedView === "logbook"
                      ? "white"
                      : isDarkMode
                        ? "#ffffff"
                        : "#1C1C1E",
                  borderRadius: "18px",
                  border:
                    selectedView === "logbook"
                      ? "none"
                      : isDarkMode
                        ? "1px solid #3a3a3a"
                        : "1px solid #E5E5E5",
                  boxShadow:
                    selectedView === "logbook"
                      ? "0 2px 8px rgba(0, 122, 255, 0.3)"
                      : isDarkMode
                        ? "0 2px 4px rgba(0, 0, 0, 0.2)"
                        : "0 2px 4px rgba(0, 0, 0, 0.04)",
                }}
                className="w-full flex items-center gap-3 px-4 py-3 text-sm transition-smooth hover:shadow-md"
              >
                <CheckCircle2
                  style={{
                    color: selectedView === "logbook" ? "white" : "#34C759",
                  }}
                  className="w-5 h-5"
                />
                <span className="flex-1 text-left font-medium">Logbook</span>
              </button>
            </div>

            <div className="mt-6 px-3">
              <div className="flex items-center justify-between px-1 py-2 mb-2">
                <h3
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Areas
                </h3>
                <button
                  onClick={() => setShowNewAreaInput(true)}
                  style={{ color: "#8E8E93" }}
                  className="hover:text-[#1C1C1E]"
                >
                  <Plus className="w-4 h-4" />
                </button>
              </div>

              {showNewAreaInput && (
                <div className="mb-2 animate-scale-in">
                  <input
                    type="text"
                    value={newAreaName}
                    onChange={(e) => setNewAreaName(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === "Enter") addArea();
                    }}
                    onBlur={() => {
                      if (newAreaName.trim()) addArea();
                      else setShowNewAreaInput(false);
                    }}
                    placeholder="New Area"
                    style={{
                      color: "#1C1C1E",
                      borderRadius: "12px",
                      border: "1px solid #E5E5E5",
                      backgroundColor: "white",
                      boxShadow: "0 2px 4px rgba(0, 0, 0, 0.04)",
                    }}
                    className="w-full px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
                    autoFocus
                  />
                </div>
              )}

              <div className="space-y-2">
                {areas.map((area) => {
                  const areaProjects = projects.filter(
                    (p) => p.areaId === area.id,
                  );
                  const hasProjects = areaProjects.length > 0;
                  const isExpanded = expandedAreas[area.id];

                  return (
                    <div key={area.id}>
                      <button
                        onClick={() => {
                          setSelectedView("area");
                          setSelectedArea(area.id);
                          setSelectedProject(null);
                        }}
                        onContextMenu={(e) => {
                          e.preventDefault();
                          setSettingsPanelItem(area);
                          setSettingsPanelType("area");
                          setShowSettingsPanel(true);
                        }}
                        onDragOver={(e) => handleProjectDragOverArea(e, area)}
                        onDrop={(e) => handleProjectDropOnArea(e, area)}
                        style={{
                          backgroundColor:
                            dragOverArea?.id === area.id
                              ? "#E3F2FF"
                              : selectedView === "area" &&
                                  selectedArea === area.id
                                ? "#007AFF"
                                : "white",
                          color:
                            selectedView === "area" && selectedArea === area.id
                              ? "white"
                              : "#1C1C1E",
                          borderRadius: "18px",
                          border:
                            selectedView === "area" && selectedArea === area.id
                              ? "none"
                              : "1px solid #E5E5E5",
                          boxShadow:
                            selectedView === "area" && selectedArea === area.id
                              ? "0 2px 8px rgba(0, 122, 255, 0.3)"
                              : "0 2px 4px rgba(0, 0, 0, 0.04)",
                        }}
                        className="w-full flex items-center gap-3 px-4 py-3 text-sm transition-smooth hover:shadow-md"
                      >
                        <span className="text-lg flex-shrink-0">
                          {area.emoji || "ðŸ "}
                        </span>
                        <span className="flex-1 text-left truncate font-medium">
                          {area.name}
                        </span>
                        {hasProjects && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              toggleAreaExpanded(area.id);
                            }}
                            style={{
                              color:
                                selectedView === "area" &&
                                selectedArea === area.id
                                  ? "rgba(255, 255, 255, 0.7)"
                                  : "#8E8E93",
                            }}
                            className="hover:text-[#1C1C1E] p-1 transition-smooth flex-shrink-0"
                          >
                            <ChevronRight
                              className={`w-4 h-4 transition-transform ${isExpanded ? "rotate-90" : ""}`}
                            />
                          </button>
                        )}
                      </button>

                      {/* Projects under this area */}
                      {hasProjects && isExpanded && (
                        <div className="ml-9 mt-2 space-y-2">
                          {areaProjects.map((project) => (
                            <button
                              key={project.id}
                              draggable
                              onDragStart={(e) =>
                                handleProjectDragStart(e, project)
                              }
                              onDragOver={(e) =>
                                handleProjectDragOverProject(e, project)
                              }
                              onDrop={(e) =>
                                handleProjectDropOnProject(e, project)
                              }
                              onDragEnd={handleProjectDragEnd}
                              onClick={() => {
                                setSelectedView("project");
                                setSelectedProject(project.id);
                                setSelectedArea(null);
                              }}
                              onContextMenu={(e) => {
                                e.preventDefault();
                                setSettingsPanelItem(project);
                                setSettingsPanelType("project");
                                setShowSettingsPanel(true);
                              }}
                              style={{
                                backgroundColor:
                                  dragOverProject?.id === project.id
                                    ? "#E3F2FF"
                                    : selectedView === "project" &&
                                        selectedProject === project.id
                                      ? "#007AFF"
                                      : "white",
                                color:
                                  selectedView === "project" &&
                                  selectedProject === project.id
                                    ? "white"
                                    : "#1C1C1E",
                                borderRadius: "18px",
                                border:
                                  selectedView === "project" &&
                                  selectedProject === project.id
                                    ? "none"
                                    : "1px solid #E5E5E5",
                                boxShadow:
                                  selectedView === "project" &&
                                  selectedProject === project.id
                                    ? "0 2px 8px rgba(0, 122, 255, 0.3)"
                                    : "0 2px 4px rgba(0, 0, 0, 0.04)",
                                cursor: "grab",
                              }}
                              className="w-full flex items-center gap-3 px-4 py-2 text-sm transition-smooth group hover:shadow-md active:cursor-grabbing"
                            >
                              <span className="text-base flex-shrink-0">
                                {project.emoji || "ðŸŽ¯"}
                              </span>
                              <span className="flex-1 text-left truncate font-medium text-xs">
                                {project.name}
                              </span>
                              {showTaskCounts && (
                                <span
                                  style={{
                                    color:
                                      selectedView === "project" &&
                                      selectedProject === project.id
                                        ? "rgba(255,255,255,0.7)"
                                        : isDarkMode
                                          ? "#ffffff"
                                          : "#8E8E93",
                                    backgroundColor:
                                      selectedView === "project" &&
                                      selectedProject === project.id
                                        ? "rgba(255,255,255,0.3)"
                                        : isDarkMode
                                          ? "#3a3a3a"
                                          : "#F0F0F5",
                                    borderRadius: "10px",
                                  }}
                                  className="text-xs px-2 py-0.5 font-semibold min-w-[24px] text-center"
                                >
                                  {
                                    tasks.filter(
                                      (t) =>
                                        t.projectId === project.id &&
                                        !t.completed,
                                    ).length
                                  }
                                </span>
                              )}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="mt-6 px-3 pb-4">
              <div className="flex items-center justify-between px-1 py-2 mb-2">
                <h3
                  style={{ color: "#8E8E93" }}
                  className="text-xs font-semibold uppercase"
                >
                  Projects
                </h3>
                <button
                  onClick={() => setShowNewProjectInput(true)}
                  style={{ color: "#8E8E93" }}
                  className="hover:text-[#1C1C1E]"
                >
                  <Plus className="w-4 h-4" />
                </button>
              </div>

              {showNewProjectInput && (
                <div className="mb-2 animate-scale-in">
                  <input
                    type="text"
                    value={newProjectName}
                    onChange={(e) => setNewProjectName(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === "Enter") addProject();
                    }}
                    onBlur={() => {
                      if (newProjectName.trim()) addProject();
                      else setShowNewProjectInput(false);
                    }}
                    placeholder="New Project"
                    style={{
                      color: "#1C1C1E",
                      borderRadius: "12px",
                      border: "1px solid #E5E5E5",
                      backgroundColor: "white",
                      boxShadow: "0 2px 4px rgba(0, 0, 0, 0.04)",
                    }}
                    className="w-full px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#007AFF]"
                    autoFocus
                  />
                </div>
              )}

              <div className="space-y-2">
                {/* Only show projects without an area */}
                {projects
                  .filter((p) => !p.areaId)
                  .map((project) => (
                    <button
                      key={project.id}
                      draggable
                      onDragStart={(e) => handleProjectDragStart(e, project)}
                      onDragOver={(e) =>
                        handleProjectDragOverProject(e, project)
                      }
                      onDrop={(e) => handleProjectDropOnProject(e, project)}
                      onDragEnd={handleProjectDragEnd}
                      onClick={() => {
                        setSelectedView("project");
                        setSelectedProject(project.id);
                        setSelectedArea(null);
                      }}
                      onContextMenu={(e) => {
                        e.preventDefault();
                        setSettingsPanelItem(project);
                        setSettingsPanelType("project");
                        setShowSettingsPanel(true);
                      }}
                      style={{
                        backgroundColor:
                          dragOverProject?.id === project.id
                            ? "#E3F2FF"
                            : selectedView === "project" &&
                                selectedProject === project.id
                              ? "#007AFF"
                              : "white",
                        color:
                          selectedView === "project" &&
                          selectedProject === project.id
                            ? "white"
                            : "#1C1C1E",
                        borderRadius: "18px",
                        border:
                          selectedView === "project" &&
                          selectedProject === project.id
                            ? "none"
                            : "1px solid #E5E5E5",
                        boxShadow:
                          selectedView === "project" &&
                          selectedProject === project.id
                            ? "0 2px 8px rgba(0, 122, 255, 0.3)"
                            : "0 2px 4px rgba(0, 0, 0, 0.04)",
                        cursor: "grab",
                      }}
                      className="w-full flex items-center gap-3 px-4 py-2 text-sm transition-smooth group hover:shadow-md active:cursor-grabbing"
                    >
                      <span className="text-lg flex-shrink-0">
                        {project.emoji || "ðŸŽ¯"}
                      </span>
                      <span className="flex-1 text-left truncate font-medium">
                        {project.name}
                      </span>
                      {showTaskCounts && (
                        <span
                          style={{
                            color:
                              selectedView === "project" &&
                              selectedProject === project.id
                                ? "rgba(255,255,255,0.7)"
                                : isDarkMode
                                  ? "#ffffff"
                                  : "#8E8E93",
                            backgroundColor:
                              selectedView === "project" &&
                              selectedProject === project.id
                                ? "rgba(255,255,255,0.3)"
                                : isDarkMode
                                  ? "#3a3a3a"
                                  : "#F0F0F5",
                            borderRadius: "10px",
                          }}
                          className="text-xs px-2 py-0.5 font-semibold min-w-[24px] text-center"
                        >
                          {
                            tasks.filter(
                              (t) => t.projectId === project.id && !t.completed,
                            ).length
                          }
                        </span>
                      )}
                    </button>
                  ))}
              </div>
            </div>
          </div>

          {/* Settings Button at Bottom */}
          <div
            style={{
              borderTop: isDarkMode ? "1px solid #2a2a2a" : "1px solid #E5E5E5",
              padding: "12px",
            }}
          >
            <button
              onClick={() => setShowAppSettings(true)}
              style={{
                backgroundColor: isDarkMode ? "#2a2a2a" : "white",
                color: isDarkMode ? "#ffffff" : "#8E8E93",
                borderRadius: "18px",
                border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
                boxShadow: isDarkMode
                  ? "0 2px 4px rgba(0, 0, 0, 0.2)"
                  : "0 2px 4px rgba(0, 0, 0, 0.04)",
              }}
              className={`w-full flex items-center gap-3 px-4 py-3 text-sm transition-smooth hover:shadow-md ${isDarkMode ? "hover:text-[#ffffff]" : "hover:text-[#1C1C1E]"}`}
            >
              <Settings className="w-5 h-5" />
              <span className="flex-1 text-left font-medium">Settings</span>
            </button>
          </div>
        </div>
      </div>

      <div
        className="flex-1 flex flex-col relative"
        style={{
          backgroundColor: "transparent",
          zIndex: 20,
        }}
      >
        <div
          style={{
            backgroundColor: isDarkMode
              ? "#252525"
              : selectedTheme !== "none"
                ? "transparent"
                : "white",
            backdropFilter:
              selectedTheme !== "none" && !isDarkMode ? "blur(30px)" : "none",
            borderBottom: isDarkMode
              ? "1px solid #3a3a3a"
              : selectedTheme !== "none"
                ? "1px solid rgba(229, 229, 229, 0.2)"
                : "1px solid #E5E5E5",
          }}
          className="px-6 py-4"
        >
          <div className="flex items-center gap-3">
            <div
              onClick={() => {
                if (selectedView === "project" || selectedView === "area") {
                  setShowEmojiPicker(true);
                }
              }}
              style={{
                backgroundColor: getViewIcon().emoji
                  ? "transparent"
                  : getViewIcon().color,
                borderRadius: "16px",
                cursor:
                  selectedView === "project" || selectedView === "area"
                    ? "pointer"
                    : "default",
              }}
              className="w-10 h-10 flex items-center justify-center hover:opacity-80 transition-smooth"
            >
              {getViewIcon().emoji ? (
                <span className="text-4xl">{getViewIcon().emoji}</span>
              ) : (
                <div style={{ color: "white" }}>{getViewIcon().icon}</div>
              )}
            </div>
            <div className="flex-1">
              {editingHeaderName &&
              (selectedView === "project" || selectedView === "area") ? (
                <input
                  type="text"
                  defaultValue={
                    selectedView === "project"
                      ? projects.find((p) => p.id === selectedProject)?.name
                      : areas.find((a) => a.id === selectedArea)?.name
                  }
                  onKeyDown={(e) => {
                    if (e.key === "Enter") {
                      if (selectedView === "project") {
                        updateProject(selectedProject, {
                          name: e.target.value,
                        });
                      } else if (selectedView === "area") {
                        updateArea(selectedArea, { name: e.target.value });
                      }
                      setEditingHeaderName(false);
                    } else if (e.key === "Escape") {
                      setEditingHeaderName(false);
                    }
                  }}
                  onBlur={(e) => {
                    if (e.target.value.trim()) {
                      if (selectedView === "project") {
                        updateProject(selectedProject, {
                          name: e.target.value,
                        });
                      } else if (selectedView === "area") {
                        updateArea(selectedArea, { name: e.target.value });
                      }
                    }
                    setEditingHeaderName(false);
                  }}
                  style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                  className="text-2xl font-semibold outline-none bg-transparent border-b-2 border-blue-500"
                  autoFocus
                />
              ) : (
                <h2
                  style={{ color: isDarkMode ? "#ffffff" : "#1C1C1E" }}
                  className="text-2xl font-semibold"
                  onDoubleClick={() => {
                    if (selectedView === "project" || selectedView === "area") {
                      setEditingHeaderName(true);
                    }
                  }}
                >
                  {selectedView === "inbox" && "Inbox"}
                  {selectedView === "today" && "Today"}
                  {selectedView === "upcoming" && "Upcoming"}
                  {selectedView === "review" && "Review"}
                  {selectedView === "someday" && "Someday"}
                  {selectedView === "logbook" && "Logbook"}
                  {selectedView === "project" &&
                    projects.find((p) => p.id === selectedProject)?.name}
                  {selectedView === "area" &&
                    areas.find((a) => a.id === selectedArea)?.name}
                </h2>
              )}
              <p style={{ color: "#8E8E93" }} className="text-xs mt-0.5">
                {getFilteredTasks.filter((t) => !t.completed).length}{" "}
                {getFilteredTasks.filter((t) => !t.completed).length === 1
                  ? "task"
                  : "tasks"}
                {selectedView === "logbook" &&
                  ` â€¢ ${getFilteredTasks.length} completed`}
              </p>
            </div>
          </div>
        </div>

        <EmojiPickerPanel />

        <div className="flex-1 overflow-y-auto pb-32">
          {selectedView === "review" ? (
            <div className="p-6 space-y-5">
              {/* Today & Overdue */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3
                    style={{ color: "#1C1C1E" }}
                    className="text-sm font-semibold"
                  >
                    Today & Overdue
                  </h3>
                  <span style={{ color: "#8E8E93" }} className="text-xs">
                    {
                      tasks.filter(
                        (t) =>
                          !t.completed &&
                          (t.when === "today" ||
                            (t.deadline && new Date(t.deadline) < new Date())),
                      ).length
                    }{" "}
                    tasks
                  </span>
                </div>
                <div className="space-y-2">
                  {tasks.filter(
                    (t) =>
                      !t.completed &&
                      (t.when === "today" ||
                        (t.deadline && new Date(t.deadline) < new Date())),
                  ).length === 0 ? (
                    <div
                      style={{
                        backgroundColor: isDarkMode ? "#2a2a2a" : "#F9F9F9",
                        borderRadius: "16px",
                        padding: "32px",
                        textAlign: "center",
                        maxWidth: showTaskDetail
                          ? "calc(100% - 440px)"
                          : "100%",
                        transition:
                          "max-width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)",
                      }}
                    >
                      <p style={{ color: "#8E8E93" }} className="text-sm">
                        No urgent tasks
                      </p>
                    </div>
                  ) : (
                    tasks
                      .filter(
                        (t) =>
                          !t.completed &&
                          (t.when === "today" ||
                            (t.deadline && new Date(t.deadline) < new Date())),
                      )
                      .map((task) => <TaskItem key={task.id} task={task} />)
                  )}
                </div>
              </div>

              {/* This Week */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3
                    style={{ color: "#1C1C1E" }}
                    className="text-sm font-semibold"
                  >
                    This Week
                  </h3>
                  <span style={{ color: "#8E8E93" }} className="text-xs">
                    {(() => {
                      const weekFromNow = new Date();
                      weekFromNow.setDate(weekFromNow.getDate() + 7);
                      return tasks.filter(
                        (t) =>
                          !t.completed &&
                          t.deadline &&
                          new Date(t.deadline) >= new Date() &&
                          new Date(t.deadline) <= weekFromNow,
                      ).length;
                    })()}{" "}
                    tasks
                  </span>
                </div>
                <div className="space-y-2">
                  {(() => {
                    const weekFromNow = new Date();
                    weekFromNow.setDate(weekFromNow.getDate() + 7);
                    const weekTasks = tasks.filter(
                      (t) =>
                        !t.completed &&
                        t.deadline &&
                        new Date(t.deadline) >= new Date() &&
                        new Date(t.deadline) <= weekFromNow,
                    );
                    return weekTasks.length === 0 ? (
                      <div
                        style={{
                          backgroundColor: isDarkMode ? "#2a2a2a" : "#F9F9F9",
                          borderRadius: "16px",
                          padding: "32px",
                          textAlign: "center",
                          maxWidth: showTaskDetail
                            ? "calc(100% - 440px)"
                            : "100%",
                          transition:
                            "max-width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)",
                        }}
                      >
                        <p style={{ color: "#8E8E93" }} className="text-sm">
                          No tasks this week
                        </p>
                      </div>
                    ) : (
                      weekTasks.map((task) => (
                        <TaskItem key={task.id} task={task} />
                      ))
                    );
                  })()}
                </div>
              </div>

              {/* High Priority */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3
                    style={{ color: "#1C1C1E" }}
                    className="text-sm font-semibold"
                  >
                    High Priority
                  </h3>
                  <span style={{ color: "#8E8E93" }} className="text-xs">
                    {
                      tasks.filter((t) => !t.completed && t.priority === "high")
                        .length
                    }{" "}
                    tasks
                  </span>
                </div>
                <div className="space-y-2">
                  {tasks.filter((t) => !t.completed && t.priority === "high")
                    .length === 0 ? (
                    <div
                      style={{
                        backgroundColor: isDarkMode ? "#2a2a2a" : "#F9F9F9",
                        borderRadius: "16px",
                        padding: "32px",
                        textAlign: "center",
                        maxWidth: showTaskDetail
                          ? "calc(100% - 440px)"
                          : "100%",
                        transition:
                          "max-width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)",
                      }}
                    >
                      <p style={{ color: "#8E8E93" }} className="text-sm">
                        No high priority tasks
                      </p>
                    </div>
                  ) : (
                    tasks
                      .filter((t) => !t.completed && t.priority === "high")
                      .map((task) => <TaskItem key={task.id} task={task} />)
                  )}
                </div>
              </div>

              {/* Recently Completed */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3
                    style={{ color: "#1C1C1E" }}
                    className="text-sm font-semibold"
                  >
                    Recently Completed
                  </h3>
                  <span style={{ color: "#8E8E93" }} className="text-xs">
                    {(() => {
                      const weekAgo = new Date();
                      weekAgo.setDate(weekAgo.getDate() - 7);
                      return tasks.filter(
                        (t) =>
                          t.completed &&
                          t.completedAt &&
                          new Date(t.completedAt) >= weekAgo,
                      ).length;
                    })()}{" "}
                    tasks
                  </span>
                </div>
                <div className="space-y-2">
                  {(() => {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    const recentlyCompleted = tasks.filter(
                      (t) =>
                        t.completed &&
                        t.completedAt &&
                        new Date(t.completedAt) >= weekAgo,
                    );
                    return recentlyCompleted.length === 0 ? (
                      <div
                        style={{
                          backgroundColor: isDarkMode ? "#2a2a2a" : "#F9F9F9",
                          borderRadius: "16px",
                          padding: "32px",
                          textAlign: "center",
                          maxWidth: showTaskDetail
                            ? "calc(100% - 440px)"
                            : "100%",
                          transition:
                            "max-width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)",
                        }}
                      >
                        <p style={{ color: "#8E8E93" }} className="text-sm">
                          No completed tasks yet
                        </p>
                      </div>
                    ) : (
                      recentlyCompleted
                        .slice(0, 10)
                        .map((task) => <TaskItem key={task.id} task={task} />)
                    );
                  })()}
                </div>
              </div>
            </div>
          ) : selectedView === "upcoming" ? (
            <div>
              {(() => {
                const dateGroups = getUpcomingTasksByDate();
                let currentMonth = "";

                return dateGroups.map(
                  ({ date, tasks: dateTasks, isEmpty, dateObj }) => {
                    const header = formatDateHeader(dateObj);
                    const showMonthHeader =
                      currentMonth !== `${header.month} ${header.year}`;
                    if (showMonthHeader) {
                      currentMonth = `${header.month} ${header.year}`;
                    }

                    return (
                      <div key={date}>
                        {showMonthHeader && (
                          <div
                            style={{
                              backgroundColor: "rgba(255, 255, 255, 0.95)",
                              borderBottom:
                                "1px solid rgba(229, 229, 229, 0.6)",
                              backdropFilter: "blur(10px)",
                            }}
                            className="px-6 py-3 sticky top-0 z-10"
                          >
                            <h2
                              style={{
                                color: "#1C1C1E",
                                fontSize: "18px",
                                fontWeight: "600",
                              }}
                            >
                              {currentMonth}
                            </h2>
                          </div>
                        )}
                        <div
                          style={{
                            borderBottom: "1px solid rgba(229, 229, 229, 0.6)",
                            backgroundColor: "rgba(255, 255, 255, 0.7)",
                            backdropFilter: "blur(10px)",
                          }}
                          className="px-6 py-4 hover:bg-[rgba(249,249,249,0.8)] transition-smooth"
                        >
                          <div className="flex items-center gap-4 mb-2">
                            <div
                              style={{
                                width: "56px",
                                height: "56px",
                                borderRadius: "12px",
                                backgroundColor: header.isToday
                                  ? "#007AFF"
                                  : "rgba(240, 240, 245, 0.9)",
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                                flexDirection: "column",
                                flexShrink: 0,
                                backdropFilter: "blur(10px)",
                              }}
                            >
                              <span
                                style={{
                                  color: header.isToday ? "white" : "#1C1C1E",
                                  fontSize: "24px",
                                  fontWeight: "600",
                                  lineHeight: "1",
                                }}
                              >
                                {header.day}
                              </span>
                              <span
                                style={{
                                  color: header.isToday
                                    ? "rgba(255,255,255,0.8)"
                                    : "#8E8E93",
                                  fontSize: "11px",
                                  fontWeight: "500",
                                  marginTop: "2px",
                                }}
                              >
                                {header.label}
                              </span>
                            </div>
                            {!isEmpty && (
                              <div
                                style={{ color: "#8E8E93", fontSize: "13px" }}
                              >
                                {dateTasks.length}{" "}
                                {dateTasks.length === 1 ? "task" : "tasks"}
                              </div>
                            )}
                          </div>
                          {!isEmpty && (
                            <div className="ml-[72px] space-y-2">
                              {dateTasks.map((task) => (
                                <TaskItem key={task.id} task={task} />
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  },
                );
              })()}
            </div>
          ) : getFilteredTasks.length === 0 ? (
            <div className="flex items-center justify-center h-64">
              <div className="text-center">
                <div style={{ color: "#C7C7CC" }} className="mb-3">
                  {selectedView === "inbox" && (
                    <Inbox className="w-16 h-16 mx-auto" />
                  )}
                  {selectedView === "today" && (
                    <Star className="w-16 h-16 mx-auto" />
                  )}
                  {selectedView === "anytime" && (
                    <List className="w-16 h-16 mx-auto" />
                  )}
                  {selectedView === "someday" && (
                    <ChevronRight className="w-16 h-16 mx-auto" />
                  )}
                  {selectedView === "logbook" && (
                    <CheckCircle2 className="w-16 h-16 mx-auto" />
                  )}
                  {(selectedView === "project" || selectedView === "area") && (
                    <Circle className="w-16 h-16 mx-auto" />
                  )}
                </div>
                <p style={{ color: "#8E8E93" }} className="text-lg font-medium">
                  {selectedView === "inbox" && "Your Inbox is empty"}
                  {selectedView === "today" && "Nothing planned for today"}
                  {selectedView === "anytime" && "No anytime tasks"}
                  {selectedView === "someday" && "No someday tasks"}
                  {selectedView === "logbook" && "No completed tasks"}
                  {(selectedView === "project" || selectedView === "area") &&
                    "No tasks here"}
                </p>
                <p style={{ color: "#C7C7CC" }} className="text-sm mt-1">
                  {selectedView === "logbook"
                    ? "Tasks you complete will appear here"
                    : "Press Shift+N or type below to add a task"}
                </p>
              </div>
            </div>
          ) : (
            <div className="p-4 space-y-2">
              {getFilteredTasks.map((task) => (
                <TaskItem key={task.id} task={task} />
              ))}
            </div>
          )}
        </div>

        <div
          className="fixed bottom-8 z-50"
          style={{
            left: showTaskDetail ? "calc(50vw - 58px)" : "calc(50vw + 134px)",
            transform: "translateX(-50%)",
            transition: "left 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",
          }}
        >
          <div
            style={{
              backgroundColor: isDarkMode ? "#2a2a2a" : "white",
              boxShadow: "0 12px 40px rgba(0, 0, 0, 0.15)",
              borderRadius: "50px",
              border: isDarkMode ? "1px solid #3a3a3a" : "1px solid #E5E5E5",
              width: newTaskInput ? "500px" : "280px",
              transition: "width 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",
            }}
            className="flex items-center gap-3 pl-4 pr-6 py-3.5"
          >
            <div className="flex-1 relative flex items-center">
              <input
                ref={inputRef}
                type="text"
                value={newTaskInput}
                onChange={(e) => {
                  const value = e.target.value;
                  const cursorPos = e.target.selectionStart;

                  // Store cursor position
                  cursorPositionRef.current = cursorPos;

                  setNewTaskInput(value);

                  // Detect date/time phrases
                  if (value.trim()) {
                    const parsed = parseNaturalLanguageDate(value);
                    if (parsed) {
                      setDetectedDateTime(parsed);
                      // Find the position of the matched text
                      const lowerValue = value.toLowerCase();
                      const lowerMatched = parsed.matchedText.toLowerCase();
                      const startIndex = lowerValue.indexOf(lowerMatched);
                      if (startIndex !== -1) {
                        setHighlightedRange({
                          start: startIndex,
                          end: startIndex + parsed.matchedText.length,
                        });
                      }
                    } else {
                      setDetectedDateTime(null);
                      setHighlightedRange(null);
                    }
                  } else {
                    setDetectedDateTime(null);
                    setHighlightedRange(null);
                  }
                }}
                onKeyDown={(e) => {
                  if (e.key === "Enter" && newTaskInput.trim()) {
                    e.preventDefault();
                    addTask({});
                    setHighlightedRange(null);
                  }
                }}
                placeholder="New To-Do"
                style={{
                  color: highlightedRange
                    ? "transparent"
                    : isDarkMode
                      ? "#ffffff"
                      : "#1C1C1E",
                  caretColor: isDarkMode ? "#ffffff" : "#1C1C1E",
                }}
                className="flex-1 text-sm outline-none bg-transparent w-full relative z-10"
              />
              {highlightedRange && newTaskInput && (
                <div
                  className="absolute left-0 text-sm pointer-events-none whitespace-nowrap overflow-hidden"
                  style={{
                    color: isDarkMode ? "#ffffff" : "#1C1C1E",
                    top: "50%",
                    transform: "translateY(-50%)",
                  }}
                >
                  <span
                    style={{
                      color: isDarkMode ? "#ffffff" : "#1C1C1E",
                      fontWeight: "400",
                    }}
                  >
                    {newTaskInput.substring(0, highlightedRange.start)}
                  </span>
                  <span
                    style={{
                      color: "#007AFF",
                      fontWeight: "600",
                      transition: "color 0.2s ease",
                    }}
                  >
                    {newTaskInput.substring(
                      highlightedRange.start,
                      highlightedRange.end,
                    )}
                  </span>
                  <span
                    style={{
                      color: isDarkMode ? "#ffffff" : "#1C1C1E",
                      fontWeight: "400",
                    }}
                  >
                    {newTaskInput.substring(highlightedRange.end)}
                  </span>
                </div>
              )}
            </div>
            <button
              onClick={() => {
                if (newTaskInput.trim()) {
                  addTask({});
                  setHighlightedRange(null);
                }
              }}
              className="flex-shrink-0  hover:opacity-80 transition-smooth"
            >
              <Plus style={{ color: "#007AFF" }} className="w-5 h-5" />
            </button>
          </div>
        </div>
      </div>
      {showTaskDetail && <TaskDetailPanel />}
      <TagManagementPanel />
      <ProjectManagementPanel />
      <QuickFindPanel />
      <ProjectAreaSettingsPanel />
      <AppSettingsPanel />

      {/* Context Menu */}
      {contextMenu && (
        <div
          onClick={(e) => e.stopPropagation()}
          style={{
            position: "fixed",
            left: `${contextMenu.x}px`,
            top: `${contextMenu.y}px`,
            backgroundColor: "white",
            borderRadius: "12px",
            border: "1px solid #E5E5E5",
            boxShadow: "0 8px 24px rgba(0, 0, 0, 0.15)",
            zIndex: 1000,
            minWidth: "200px",
            overflow: "hidden",
          }}
          className="animate-scale-in"
        >
          <button
            onClick={() => {
              setSelectedTask(contextMenu.task);
              setShowTaskDetail(true);
              setContextMenu(null);
            }}
            style={{
              width: "100%",
              padding: "12px 16px",
              textAlign: "left",
              border: "none",
              backgroundColor: "white",
              color: "#1C1C1E",
              fontSize: "14px",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "8px",
            }}
            className="hover:bg-[#F5F5F5] transition-smooth"
          >
            <StickyNote className="w-4 h-4" style={{ color: "#007AFF" }} />
            Open Details
          </button>
          <button
            onClick={() => {
              toggleTaskComplete(contextMenu.task.id);
              setContextMenu(null);
            }}
            style={{
              width: "100%",
              padding: "12px 16px",
              textAlign: "left",
              border: "none",
              backgroundColor: "white",
              color: "#1C1C1E",
              fontSize: "14px",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "8px",
            }}
            className="hover:bg-[#F5F5F5] transition-smooth"
          >
            <CheckCircle2 className="w-4 h-4" style={{ color: "#34C759" }} />
            {contextMenu.task.completed ? "Mark Incomplete" : "Mark Complete"}
          </button>
          <div
            style={{
              height: "1px",
              backgroundColor: "#E5E5E5",
              margin: "4px 0",
            }}
          />
          <button
            onClick={() => {
              if (
                (showConfirmDialogs &&
                  confirm(`Delete task "${contextMenu.task.title}"?`)) ||
                !showConfirmDialogs
              ) {
                deleteTask(contextMenu.task.id);
                setContextMenu(null);
              }
            }}
            style={{
              width: "100%",
              padding: "12px 16px",
              textAlign: "left",
              border: "none",
              backgroundColor: "white",
              color: "#FF3B30",
              fontSize: "14px",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "8px",
            }}
            className="hover:bg-[#FF3B3010] transition-smooth"
          >
            <Trash2 className="w-4 h-4" />
            Delete Task
          </button>
        </div>
      )}
    </div>
  );
};

export default StuffApp;
